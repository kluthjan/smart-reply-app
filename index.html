<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartReply Assistent</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Error Overlay Style */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            z-index: 9999;
            overflow: auto;
            font-family: monospace;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-50">
    <div id="error-overlay"></div>
    <div id="root"></div>

    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            const div = document.getElementById('error-overlay');
            div.style.display = 'block';
            div.innerHTML = `<h3>Kritischer Fehler</h3><p>${msg}</p><pre>${url}:${line}:${col}</pre><pre>${error && error.stack}</pre>`;
        };
    </script>

    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

        const SELECTED_MODEL = "Llama-3.2-3B-Instruct-q4f16_1-MLC"; // ~2GB, modern, fast

        window.webLLM = {
            engine: null,
            isLoaded: false,

            async init() {
                if (this.engine) return;

                const initProgressCallback = (report) => {
                    window.dispatchEvent(new CustomEvent('webllm-progress', { detail: report }));
                };

                this.engine = await CreateMLCEngine(SELECTED_MODEL, {
                    initProgressCallback,
                    logLevel: "INFO"
                });
                this.isLoaded = true;
            },

            async generate(messages) {
                if (!this.engine) await this.init();

                const response = await this.engine.chat.completions.create({
                    messages,
                    temperature: 0.7,
                    max_tokens: 1024,
                });
                return response.choices[0].message.content;
            }
        };
    </script>

    <script type="text/babel" data-presets="env,react">
        // --- React Imports ---
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Icon Components (Lucide Mock) ---
        const IconBase = ({ children, className = "w-4 h-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Mail = p => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></IconBase>;
        const FileText = p => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconBase>;
        const Copy = p => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></IconBase>;
        const Sparkles = p => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></IconBase>;
        const Settings = p => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Check = p => <IconBase {...p}><polyline points="20 6 9 17 4 12" /></IconBase>;
        const Clipboard = p => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /></IconBase>;
        const ArrowRight = p => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></IconBase>;
        const Zap = p => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const LogOut = p => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>;
        const RefreshCw = p => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>;
        const Plus = p => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>;
        const Trash2 = p => <IconBase {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const Save = p => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Building2 = p => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" /><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" /><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" /><path d="M10 6h4" /><path d="M10 10h4" /><path d="M10 14h4" /><path d="M10 18h4" /></IconBase>;
        const RotateCcw = p => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>;
        const Key = p => <IconBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></IconBase>;
        const AlertTriangle = p => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const X = p => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>;
        const Cpu = p => <IconBase {...p}><rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M15 2v2" /><path d="M15 20v2" /><path d="M2 15h2" /><path d="M2 9h2" /><path d="M20 15h2" /><path d="M20 9h2" /><path d="M9 2v2" /><path d="M9 20v2" /></IconBase>;
        const Rocket = p => <IconBase {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" /><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" /><path d="M9 12H4s.55-3.03 2-4c1.62-1.1 4-1 4-1s-1.07 1.83-1 4z" /><path d="M12 15v5s3.03-.55 4-2c1.1-1.62 1-4 1-4s-1.83 1.07-4 1z" /></IconBase>;
        const FilePenLine = p => <IconBase {...p}><path d="m18 5-3-3H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2" /><path d="M8 18h1" /><path d="M18.4 2.6a2.17 2.17 0 0 1 3 3L16 11l-4 1 1-4Z" /></IconBase>;
        const WifiOff = p => <IconBase {...p}><line x1="2" y1="2" x2="22" y2="22" /><path d="M8.5 8.5A10 10 0 0 1 22 12" /><path d="M5 12a7 7 0 0 1 7-7 7 7 0 0 1 7 7" /><path d="M8.52 16.48A4 4 0 0 1 12 16c1.1 0 2.1.4 2.9 1.1" /><path d="M12 20h.01" /></IconBase>;
        const Globe = p => <IconBase {...p}><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconBase>;


        const TRANSLATIONS = {
            de: {
                title: "SmartReply Assistent",
                settings: "Einstellungen",
                workspace: "Workspace",
                incoming: "Eingehende Nachricht",
                paste: "Einfügen",
                copy: "Kopieren",
                copied: "Kopiert",
                reset: "Reset",
                confirmReset: "Wirklich löschen?",
                demo: "Demo Text laden",
                aiResponse: "KI-Antwort",
                fallback: "Fallback aktiv",
                generating: "generiert...",
                instrPlaceholder: 'Z.B. "Biete 5% Rabatt an" oder "Fasse dich kürzer"',
                manage: "Verwaltung",
                shops: "SHOPS",
                newShop: "Neuer Shop",
                editShop: "Shop bearbeiten",
                save: "Speichern",
                offlineBtn: "Offline-KI aktivieren",
                apiConfig: "KI & API Konfiguration",
                stdPolicy: "Standard-Richtlinien",
                policyLabel: "Richtlinien & Tonalität",
                name: "Name",
                apiKey: "API Key",
                appReset: "App komplett Reset",
                confirmAppReset: "Wirklich zurücksetzen?",
                genPolicyDefault: `ALLGEMEINE STANDARD-RICHTLINIE:\n- Tonalität: Professionell, höflich.\n- Ziel: Präzise Antwort.\n- LÄNGE: Kurz (2-4 Absätze).`,
                simGreeting: "Guten Tag",
                simClosing: "Mit freundlichen Grüßen",
                simBody: "vielen Dank für Ihre Nachricht. Wir haben Ihr Anliegen erfasst.",
                inputPlaceholder: "Fügen Sie hier die E-Mail des Kunden ein...",
                policyPlaceholder: "Hier Richtlinien anpassen...",
                responsePlaceholder: "Die Antwort erscheint hier...",
                directEdit: "Direkt bearbeitbar",
                activeMode: "Aktiver Modus",
                providerInfo: "Die App erkennt automatisch anhand des Keys, welchen Anbieter Sie nutzen:",
                // Auth
                username: "Benutzername",
                password: "Passwort",
                loginBtn: "Anmelden",
                registerBtn: "Registrieren",
                loading: "Lade...",
                logout: "Abmelden",
                importData: "Vorhandene Daten importieren?"
            },
            en: {
                title: "SmartReply Assistant",
                settings: "Settings",
                workspace: "Workspace",
                incoming: "Incoming Message",
                paste: "Paste",
                copy: "Copy",
                copied: "Copied",
                reset: "Reset",
                confirmReset: "Clear all?",
                demo: "Load Demo Text",
                aiResponse: "AI Response",
                fallback: "Fallback active",
                generating: "generating...",
                instrPlaceholder: 'E.g. "Offer 5% discount" or "Make it shorter"',
                manage: "Management",
                shops: "SHOPS",
                newShop: "New Shop",
                editShop: "Edit Shop",
                save: "Save",
                offlineBtn: "Enable Offline AI",
                apiConfig: "AI & API Configuration",
                stdPolicy: "Standard Policies",
                policyLabel: "Policies & Tonality",
                name: "Name",
                apiKey: "API Key",
                appReset: "Full App Reset",
                confirmAppReset: "Really reset?",
                genPolicyDefault: `GENERAL STANDARD POLICY:\n- Tone: Professional, polite.\n- Goal: Precise answer.\n- LENGTH: Short (2-4 paragraphs).`,
                simGreeting: "Hello",
                simClosing: "Best regards",
                simBody: "thank you for your message. We have received your request.",
                inputPlaceholder: "Paste the customer email here...",
                policyPlaceholder: "Adjust policies here...",
                responsePlaceholder: "The response text will appear here...",
                directEdit: "Directly editable",
                activeMode: "Active Mode",
                providerInfo: "The app automatically detects the provider based on your key:",
                // Auth
                username: "Username",
                password: "Password",
                loginBtn: "Login",
                registerBtn: "Register",
                loading: "Loading...",
                logout: "Logout",
                importData: "Import existing data?"
            },
            it: {
                title: "Assistente SmartReply",
                settings: "Impostazioni",
                workspace: "Workspace",
                incoming: "Messaggio in arrivo",
                paste: "Incolla",
                copy: "Copia",
                copied: "Copiato",
                reset: "Reset",
                confirmReset: "Cancellare tutto?",
                demo: "Carica testo demo",
                aiResponse: "Risposta IA",
                fallback: "Fallback attivo",
                generating: "genera...",
                instrPlaceholder: 'Es. "Offri 5% sconto" o "Falla più breve"',
                manage: "Gestione",
                shops: "NEGOZI",
                newShop: "Nuovo Negozio",
                editShop: "Modifica Negozio",
                save: "Salva",
                offlineBtn: "Attiva IA Offline",
                apiConfig: "Configurazione IA & API",
                stdPolicy: "Direttive Standard",
                policyLabel: "Direttive & Tonalità",
                name: "Nome",
                apiKey: "Chiave API",
                appReset: "Reset Completo App",
                confirmAppReset: "Resettare davvero?",
                genPolicyDefault: `DIRETTIVA STANDARD GENERALE:\n- Tono: Professionale, gentile.\n- Obiettivo: Risposta precisa.\n- LUNGHEZZA: Breve (2-4 paragrafi).`,
                simGreeting: "Buongiorno",
                simClosing: "Cordiali saluti",
                simBody: "grazie per il tuo messaggio. Abbiamo ricevuto la tua richiesta.",
                inputPlaceholder: "Incolla qui l'email del cliente...",
                policyPlaceholder: "Modifica le direttive qui...",
                responsePlaceholder: "La risposta apparirà qui...",
                directEdit: "Modificabile direttamente",
                activeMode: "Modalità Attiva",
                providerInfo: "L'app rileva automaticamente il provider in base alla chiave:",
                // Auth
                username: "Nome utente",
                password: "Password",
                loginBtn: "Accedi",
                registerBtn: "Registrati",
                loading: "Caricamento...",
                logout: "Disconnettersi",
                importData: "Importare dati esistenti?"
            },
            es: {
                title: "Asistente SmartReply",
                settings: "Ajustes",
                workspace: "Espacio de trabajo",
                incoming: "Mensaje entrante",
                paste: "Pegar",
                copy: "Copiar",
                copied: "Copiado",
                reset: "Reset",
                confirmReset: "¿Borrar todo?",
                demo: "Cargar texto demo",
                aiResponse: "Respuesta IA",
                fallback: "Fallback activo",
                generating: "generando...",
                instrPlaceholder: 'Ej. "Ofrece 5% descuento" o "Más breve"',
                manage: "Gestión",
                shops: "TIENDAS",
                newShop: "Nueva Tienda",
                editShop: "Editar Tienda",
                save: "Guardar",
                offlineBtn: "Activar IA Offline",
                apiConfig: "Configuración IA y API",
                stdPolicy: "Políticas Estándar",
                policyLabel: "Políticas y Tonalidad",
                name: "Nombre",
                apiKey: "Clave API",
                appReset: "Reset Completo App",
                confirmAppReset: "¿Resetear realmente?",
                genPolicyDefault: `POLÍTICA ESTÁNDAR GENERAL:\n- Tono: Profesional, amable.\n- Objetivo: Respuesta precisa.\n- LONGITUD: Corta (2-4 párrafos).`,
                simGreeting: "Hola",
                simClosing: "Saludos cordiales",
                simBody: "gracias por su mensaje. Hemos recibido su solicitud.",
                inputPlaceholder: "Pegue el correo del cliente aquí...",
                policyPlaceholder: "Ajustar políticas aquí...",
                responsePlaceholder: "La respuesta aparecerá aquí...",
                directEdit: "Editable directamente",
                activeMode: "Modo Activo",
                providerInfo: "La aplicación detecta automáticamente el proveedor según su clave:",
                // Auth
                username: "Usuario",
                password: "Password",
                loginBtn: "Acceder",
                registerBtn: "Registrarse",
                loading: "Cargando...",
                logout: "Cerrar sesión",
                importData: "¿Importar datos existentes?"
            },
            fr: {
                title: "Assistant SmartReply",
                settings: "Paramètres",
                workspace: "Espace de travail",
                incoming: "Message entrant",
                paste: "Coller",
                copy: "Copier",
                copied: "Copié",
                reset: "Réinitialiser",
                confirmReset: "Tout effacer ?",
                demo: "Charger texte démo",
                aiResponse: "Réponse IA",
                fallback: "Fallback actif",
                generating: "génère...",
                instrPlaceholder: 'Ex. "Offre 5% remise" ou "Plus court"',
                manage: "Gestion",
                shops: "BOUTIQUES",
                newShop: "Nouvelle Boutique",
                editShop: "Modifier Boutique",
                save: "Enregistrer",
                offlineBtn: "Activer IA Hors-ligne",
                apiConfig: "Config IA & API",
                stdPolicy: "Politiques Standard",
                policyLabel: "Politiques & Tonalité",
                name: "Nom",
                apiKey: "Clé API",
                appReset: "Reset Complet App",
                confirmAppReset: "Vraiment réinitialiser ?",
                genPolicyDefault: `POLITIQUE STANDARD GÉNÉRALE :\n- Ton : Professionnel, poli.\n- Objectif : Réponse précise.\n- LONGUEUR : Court (2-4 paragraphes).`,
                simGreeting: "Bonjour",
                simClosing: "Cordialement",
                simBody: "merci pour votre message. Nous avons bien reçu votre demande.",
                inputPlaceholder: "Collez l'e-mail du client ici...",
                policyPlaceholder: "Ajustez les politiques ici...",
                responsePlaceholder: "La réponse apparaîtra ici...",
                directEdit: "Modifiable directement",
                activeMode: "Mode Actif",
                providerInfo: "L'application détecte automatiquement le fournisseur via la clé :",
                // Auth
                username: "Nom d'utilisateur",
                password: "Mot de passe",
                loginBtn: "Connexion",
                registerBtn: "S'inscrire",
                loading: "Chargement...",
                logout: "Déconnexion",
                importData: "Importer les données existantes ?"
            },
            nl: {
                title: "SmartReply Assistent",
                settings: "Instellingen",
                workspace: "Werkruimte",
                incoming: "Inkomend bericht",
                paste: "Plakken",
                copy: "Kopiëren",
                copied: "Gekopieerd",
                reset: "Reset",
                confirmReset: "Alles wissen?",
                demo: "Laad demotekst",
                aiResponse: "AI Antwoord",
                fallback: "Fallback actief",
                generating: "genereert...",
                instrPlaceholder: 'Bijv. "Bied 5% korting" of "Maak het korter"',
                manage: "Beheer",
                shops: "WINKELS",
                newShop: "Nieuwe Winkel",
                editShop: "Winkel bewerken",
                save: "Opslaan",
                offlineBtn: "Offline AI activeren",
                apiConfig: "AI & API Configuratie",
                stdPolicy: "Standaardbeleid",
                policyLabel: "Beleid & Toon",
                name: "Naam",
                apiKey: "API Sleutel",
                appReset: "Volledige App Reset",
                confirmAppReset: "Echt resetten?",
                genPolicyDefault: `ALGEMENE STANDAARD BELEID:\n- Toon: Professioneel, beleefd.\n- Doel: Precies antwoord.\n- LENGTE: Kort (2-4 paragrafen).`,
                simGreeting: "Hallo",
                simClosing: "Met vriendelijke groet",
                simBody: "bedankt voor uw bericht. We hebben uw aanvraag ontvangen.",
                inputPlaceholder: "Plak hier de e-mail van de klant...",
                policyPlaceholder: "Pas beleid hier aan...",
                responsePlaceholder: "Het antwoord verschijnt hier...",
                directEdit: "Direct bewerkbaar",
                activeMode: "Actieve Modus",
                providerInfo: "De app detecteert automatisch de provider op basis van uw sleutel:",
                // Auth
                username: "Gebruikersnaam",
                password: "Wachtwoord",
                loginBtn: "Inloggen",
                registerBtn: "Registreren",
                loading: "Laden...",
                logout: "Uitloggen",
                importData: "Bestaande gegevens importeren?"
            }
        };

        const GENERIC_ID = 'general';

        // SECURITY: DEFAULT KEY REMOVED FOR HOSTING
        const DEFAULT_TEST_KEY = '';

        const DEFAULT_COMPANIES = [
            {
                id: 'c1',
                name: 'TechNova GmbH',
                policyText: `RÜCKGABERICHTLINIEN:
- Rückgabefrist beträgt 30 Tage nach Kaufdatum.
- Artikel müssen originalverpackt sein.
- Bei Defekten übernehmen wir die Versandkosten.
- Rückerstattung erfolgt auf das ursprüngliche Zahlungsmittel innerhalb von 5 Werktagen.

TONALITY:
- Professionell, aber freundlich.
- "Du" oder "Sie" je nach Kundenanrede (Standard: Sie).
- Immer eine Ticket-ID angeben.`
            },
            {
                id: 'c2',
                name: 'Fashion Boutique',
                policyText: `UMTAUSCH:
- Nur gegen Gutschein oder andere Größe.
- Keine Barauszahlung.
- Getragene Kleidung ist vom Umtausch ausgeschlossen.
- Sale-Artikel sind finaler Verkauf (kein Umtausch).

TONALITY:
- Sehr persönlich, emotional, modebewusst.
- Immer "Du".
- Emojis sind erlaubt.`
            }
        ];

        // --- Helper: Robust Copy ---
        const robustCopyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                        resolve();
                    } catch (error) {
                        textArea.remove();
                        reject(error);
                    }
                });
            }
        };

        // --- Account & Security Managers ---
        class CryptoManager {
            constructor() {
                this.algo = { name: 'AES-GCM', length: 256 };
            }

            async deriveKey(password, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
                );

                return window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    this.algo,
                    false,
                    ["encrypt", "decrypt"]
                );
            }

            async encrypt(data, password) {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const key = await this.deriveKey(password, salt);
                const enc = new TextEncoder();

                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv }, key, enc.encode(JSON.stringify(data))
                );

                // Convert buffers to base64 for storage
                return {
                    salt: btoa(String.fromCharCode(...salt)),
                    iv: btoa(String.fromCharCode(...iv)),
                    data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
                };
            }

            async decrypt(encryptedObj, password) {
                try {
                    const salt = Uint8Array.from(atob(encryptedObj.salt), c => c.charCodeAt(0));
                    const iv = Uint8Array.from(atob(encryptedObj.iv), c => c.charCodeAt(0));
                    const data = Uint8Array.from(atob(encryptedObj.data), c => c.charCodeAt(0));

                    const key = await this.deriveKey(password, salt);

                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv }, key, data
                    );

                    const dec = new TextDecoder();
                    return JSON.parse(dec.decode(decrypted));
                } catch (e) {
                    console.error("Decryption failed:", e);
                    throw new Error("Falsches Passwort oder beschädigte Daten.");
                }
            }
        }

        const cryptoManager = new CryptoManager();

        // --- Auth Component ---
        const AuthScreen = ({ onLogin, language, setLanguage }) => {
            const [mode, setMode] = useState('login'); // login, register, reset
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const tAuth = TRANSLATIONS[language];

            const handleAuth = async () => {
                setError('');
                setIsLoading(true);

                // Simple artificial delay for UX and to prevent brute-force timing attacks (conceptually)
                await new Promise(r => setTimeout(r, 600));

                try {
                    const storageKey = `user_vault_${username}`;
                    const existingUser = localStorage.getItem(storageKey);

                    if (mode === 'login') {
                        if (!existingUser) throw new Error("Benutzer nicht gefunden.");
                        const vault = JSON.parse(existingUser);
                        const data = await cryptoManager.decrypt(vault, password);
                        onLogin(username, password, data);
                    } else if (mode === 'register') {
                        if (existingUser) throw new Error("Benutzername existiert bereits.");
                        // Check for migration data (if first user)
                        let initialData = {
                            companies: DEFAULT_COMPANIES,
                            apiKey: DEFAULT_TEST_KEY,
                            genericPolicy: tAuth.genPolicyDefault
                        };

                        // Check if we have legacy plain-text data to import
                        const legacyComps = localStorage.getItem('smart_reply_companies');
                        if (legacyComps) {
                            if (confirm("Vorhandene Daten gefunden. Importieren?")) {
                                initialData.companies = JSON.parse(legacyComps);
                                initialData.apiKey = localStorage.getItem('smart_reply_api_key') || '';
                                initialData.genericPolicy = localStorage.getItem('smart_reply_generic_policy') || tAuth.genPolicyDefault;
                            }
                        }

                        const encrypted = await cryptoManager.encrypt(initialData, password);
                        localStorage.setItem(storageKey, JSON.stringify(encrypted));
                        onLogin(username, password, initialData);
                    }
                } catch (e) {
                    setError(e.message);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl -mt-20 overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-8 text-center text-white">
                            <div className="bg-white/20 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                                <Zap className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-2xl font-bold">{tAuth.title}</h1>
                            <p className="text-blue-100 text-sm mt-2">Sichere, verschlüsselte lokale KI</p>
                        </div>

                        <div className="p-8">
                            {error && (
                                <div className="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm flex items-center gap-2">
                                    <AlertTriangle className="w-4 h-4" /> {error}
                                </div>
                            )}

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">{tAuth.username || "Benutzername"}</label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={e => setUsername(e.target.value)}
                                        className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="User123"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">{tAuth.password || "Passwort"}</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                        className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="••••••••"
                                        onKeyDown={e => e.key === 'Enter' && handleAuth()}
                                    />
                                </div>

                                <button
                                    onClick={handleAuth}
                                    disabled={!username || !password || isLoading}
                                    className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all disabled:opacity-50 disabled:shadow-none translate-y-0 active:translate-y-0.5"
                                >
                                    {isLoading ? tAuth.loading || "Lade..." : (mode === 'login' ? tAuth.loginBtn || "Anmelden" : tAuth.registerBtn || "Registrieren")}
                                </button>

                                <div className="relative py-2">
                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div>
                                    <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">oder</span></div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => alert("Demo: Google Login")} className="flex items-center justify-center gap-2 border border-slate-200 p-2 rounded-lg hover:bg-slate-50 transition-colors text-sm font-medium text-slate-600">
                                        <svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-5.3 5.44C10.13 19.27 7.22 16.22 7 12c.31-4.77 4.2-7.1 6.39-7.1c1.61 0 3.03.61 4.13 1.68l2.63-2.63A11.37 11.37 0 0 0 13.39 1c-6.21 0-10.88 4.77-10.66 11c.21 5.92 5.23 10.19 9.66 10.19c11.13 0 10.8-11.1 10.8-11.1H21.35z" /></svg> Google
                                    </button>
                                    <button onClick={() => alert("Demo: Microsoft Login")} className="flex items-center justify-center gap-2 border border-slate-200 p-2 rounded-lg hover:bg-slate-50 transition-colors text-sm font-medium text-slate-600">
                                        <svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M11.4 24H0V12.6h11.4V24zM24 24H12.6V12.6H24V24zM11.4 11.4H0V0h11.4v11.4zM24 11.4H12.6V0H24v11.4z" /></svg> Microsoft
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 text-center text-sm text-slate-500 border-t border-slate-100">
                            {mode === 'login' ? "Kein Konto? " : "Bereits registriert? "}
                            <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 font-bold hover:underline">
                                {mode === 'login' ? "Jetzt registrieren" : "Anmelden"}
                            </button>
                        </div>

                        <div className="p-4 border-t border-slate-200 bg-white flex justify-center">
                            <select
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                className="text-sm bg-transparent border-none focus:ring-0 text-slate-400 cursor-pointer"
                            >
                                <option value="de">Deutsch</option>
                                <option value="en">English</option>
                                <option value="it">Italiano</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="nl">Nederlands</option>
                            </select>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        function App() {
            // --- Global Auth State ---
            const [currentUser, setCurrentUser] = useState(null); // { username, password (for encryption) }
            const [language, setLanguage] = useState(() => localStorage.getItem('smart_reply_language') || 'de');

            // --- Persistent State (loaded from encrypted vault or defaults) ---
            const [companies, setCompanies] = useState(DEFAULT_COMPANIES);
            const [selectedCompanyId, setSelectedCompanyId] = useState(GENERIC_ID);
            const [apiKey, setApiKey] = useState(DEFAULT_TEST_KEY);
            const [genericPolicy, setGenericPolicy] = useState('');

            // --- Effects ---
            const t = TRANSLATIONS[language];

            // Initialize default generic policy if empty
            useEffect(() => {
                if (!genericPolicy) setGenericPolicy(t.genPolicyDefault);
            }, [language]);

            // Save changes to ENCRYPTED storage whenever relevant state changes
            useEffect(() => {
                if (!currentUser) return;

                const saveData = async () => {
                    const dataToEncrypt = {
                        companies,
                        apiKey,
                        genericPolicy
                    };
                    try {
                        const encrypted = await cryptoManager.encrypt(dataToEncrypt, currentUser.password);
                        localStorage.setItem(`user_vault_${currentUser.username}`, JSON.stringify(encrypted));
                        console.log("Vault saved encrypted.");
                    } catch (e) {
                        console.error("Save failed", e);
                    }
                };

                // Debounce save to avoid thrashing crypto
                const timeoutId = setTimeout(saveData, 1000);
                return () => clearTimeout(timeoutId);

            }, [companies, apiKey, genericPolicy, currentUser]);

            // --- Handlers ---
            const handleLogin = (username, password, decryptedData) => {
                setCompanies(decryptedData.companies || DEFAULT_COMPANIES);
                setApiKey(decryptedData.apiKey || '');
                setGenericPolicy(decryptedData.genericPolicy || t.genPolicyDefault);

                setCurrentUser({ username, password });
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setCompanies(DEFAULT_COMPANIES);
                setApiKey('');
            };

            if (!currentUser) {
                return <AuthScreen onLogin={handleLogin} language={language} setLanguage={setLanguage} />;
            }

            // ... (Rest of App logic needs to remove the old localStorage calls)

            // --- Runtime State ---
            const [activeTab, setActiveTab] = useState('workspace');
            const [incomingMail, setIncomingMail] = useState('');
            const [policyContent, setPolicyContent] = useState('');

            const [generatedResponse, setGeneratedResponse] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [customInstruction, setCustomInstruction] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [usedFallback, setUsedFallback] = useState(false);

            const [copySuccess, setCopySuccess] = useState(false);
            const [inputCopySuccess, setInputCopySuccess] = useState(false);
            const [manualEditMode, setManualEditMode] = useState(false);
            const [confirmReset, setConfirmReset] = useState(false);
            const [pasteError, setPasteError] = useState(false);
            const [webLLMProgress, setWebLLMProgress] = useState('');

            useEffect(() => {
                const onProgress = (e) => setWebLLMProgress(e.detail.text);
                window.addEventListener('webllm-progress', onProgress);
                return () => window.removeEventListener('webllm-progress', onProgress);
            }, []);

            // --- Settings UI State ---
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPolicy, setEditPolicy] = useState('');
            const [editApiKey, setEditApiKey] = useState('');

            // --- Helper: Detect Provider ---
            const getProvider = (key) => {
                if (key === 'webllm') return 'WEBLLM';
                if (key.startsWith('gsk_')) return 'GROQ';
                if (key.startsWith('sk-')) return 'OPENAI';
                return 'SIMULATION';
            };

            const activeProvider = getProvider(apiKey);

            // --- Effects ---
            useEffect(() => { localStorage.setItem('smart_reply_last_company', selectedCompanyId); }, [selectedCompanyId]);
            useEffect(() => { setEditApiKey(apiKey); }, [apiKey]);
            useEffect(() => { localStorage.setItem('smart_reply_language', language); }, [language]);

            useEffect(() => {
                if (selectedCompanyId === GENERIC_ID) {
                    setPolicyContent(genericPolicy);
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    setPolicyContent(company ? company.policyText : genericPolicy);
                }
            }, [selectedCompanyId, activeTab]);

            useEffect(() => {
                if (confirmReset) {
                    const timer = setTimeout(() => setConfirmReset(false), 3000);
                    return () => clearTimeout(timer);
                }
            }, [confirmReset]);

            // --- Handlers: Logic ---
            const handlePolicyChange = (newText) => {
                setPolicyContent(newText);
                if (selectedCompanyId === GENERIC_ID) {
                    setGenericPolicy(newText);
                } else {
                    setCompanies(prev => prev.map(c =>
                        c.id === selectedCompanyId ? { ...c, policyText: newText } : c
                    ));
                }
            };

            const generateResponse = async (instruction) => {
                setIsGenerating(true);
                setManualEditMode(false);
                setErrorMsg('');
                setUsedFallback(false);
                setGeneratedResponse('');

                const company = companies.find(c => c.id === selectedCompanyId);
                const companyName = company ? company.name : 'Unser Unternehmen';
                const isGeneric = selectedCompanyId === GENERIC_ID;
                const currentPolicyText = policyContent;

                const systemPrompt = `Du bist ein Kundensupport-Agent für "${companyName}".
RICHTLINIEN:
${currentPolicyText}
${isGeneric ? "WICHTIG: Fasse dich kurz (max. 2-4 Absätze). Gib allgemeine Informationen." : ""}

AUFGABE:
Antworte dem Kunden professionell, empathisch und lösungsorientiert.
Beachte die Richtlinien genau.
Antworte NUR mit dem E-Mail-Text, ohne Einleitung wie "Hier ist ein Entwurf".`;

                const userPrompt = `Kunden-Email:
"""
${incomingMail}
"""

${instruction ? 'Zusatz-Anweisung: ' + instruction : ''}`;

                try {
                    if (activeProvider === 'WEBLLM') {
                        await callWebLLM(userPrompt, systemPrompt);
                    } else if (activeProvider === 'GROQ') {
                        await callGroqAI(userPrompt, systemPrompt);
                    } else if (activeProvider === 'OPENAI') {
                        await callOpenAI(userPrompt, systemPrompt);
                    } else {
                        await runSimulation(companyName, instruction);
                    }
                } catch (err) {
                    console.error("API Call Failed:", err);
                    let friendlyError = "Ein unbekannter Fehler ist aufgetreten.";
                    if (err.message && (err.message.includes("Failed to fetch") || err.name === 'TypeError')) {
                        // CORS or Network error
                        friendlyError = "Verbindung bei API blockiert (Netzwerk/CORS). Nutze Fallback.";
                    } else {
                        friendlyError = `API Fehler: ${err.message || err}. Nutze Fallback.`;
                    }

                    setErrorMsg(friendlyError);
                    setUsedFallback(true);
                    await runSimulation(companyName, instruction);
                } finally {
                    setIsGenerating(false);
                }
            };

            const callWebLLM = async (prompt, systemContext) => {
                if (!window.webLLM) throw new Error("WebLLM nicht geladen");
                const response = await window.webLLM.generate([
                    { role: "system", content: systemContext },
                    { role: "user", content: prompt }
                ]);
                setGeneratedResponse(response);
            };

            const callGroqAI = async (prompt, systemContext) => {
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        // mode: 'cors' is default, explicit helps debug
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                            temperature: 0.7,
                        })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error?.message || `Groq API Error (${response.status})`);
                    }
                    const data = await response.json();
                    setGeneratedResponse(data.choices[0]?.message?.content || "");
                } catch (e) {
                    throw e;
                }
            };

            const callOpenAI = async (prompt, systemContext) => {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                        temperature: 0.7,
                    })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
                const data = await response.json();
                setGeneratedResponse(data.choices[0]?.message?.content || "");
            };

            const runSimulation = async (companyName, instruction) => {
                await new Promise(r => setTimeout(r, 800));

                if (selectedCompanyId === GENERIC_ID) {
                    setGeneratedResponse(`${t.simGreeting} ${incomingMail.includes('Mustermann') ? 'Herr Mustermann' : 'Kunde'},\n\n${t.simBody}\n\n${t.simClosing},\nIhr Support-Team`);
                    return;
                }

                let isDu = policyContent.toLowerCase().includes('immer "du"');
                const hasName = incomingMail.includes('Mustermann');
                const customerName = hasName ? (isDu ? 'Max' : 'Herr Mustermann') : 'Kunde';

                let body = isDu
                    ? `danke für deine Nachricht. Wir kümmern uns darum! ${instruction ? instruction : ''}`
                    : `vielen Dank für Ihre Nachricht. Wir haben Ihr Anliegen erfasst. ${instruction ? instruction : ''}`;

                if (!instruction && !isDu) {
                    body += " Basierend auf Ihren Angaben werden wir den Vorgang prüfen und uns zeitnah mit einer Lösung bei Ihnen melden.";
                }

                setGeneratedResponse(`${isDu ? t.simGreeting : t.simGreeting} ${customerName},

${body}

${isDu ? t.simClosing : t.simClosing},
Ihr Support-Team`);
            };

            // --- Handlers ---
            const handleCopy = () => {
                robustCopyToClipboard(generatedResponse)
                    .then(() => {
                        setCopySuccess(true);
                        setTimeout(() => setCopySuccess(false), 2000);
                    })
                    .catch(() => alert('Kopieren fehlgeschlagen'));
            };

            const handleCopyInput = () => {
                robustCopyToClipboard(incomingMail)
                    .then(() => {
                        setInputCopySuccess(true);
                        setTimeout(() => setInputCopySuccess(false), 2000);
                    });
            };

            const handlePasteInput = async () => {
                setPasteError(false);
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) setIncomingMail(text);
                } catch (err) {
                    setPasteError(true);
                    setTimeout(() => setPasteError(false), 4000);
                }
            };

            const handleReset = () => {
                if (!confirmReset) {
                    setConfirmReset(true);
                } else {
                    setIncomingMail('');
                    setGeneratedResponse('');
                    setCustomInstruction('');
                    setManualEditMode(false);
                    setErrorMsg('');
                    setUsedFallback(false);
                    setCopySuccess(false);
                    setInputCopySuccess(false);
                    setConfirmReset(false);
                }
            };

            const handleFactoryReset = () => {
                if (confirmReset) {
                    localStorage.clear();
                    window.location.reload();
                } else {
                    setConfirmReset(true);
                }
            };

            // --- Settings Handlers ---
            const startAdding = () => { setEditingId('NEW'); setEditName('Neuer Shop'); setEditPolicy(''); };
            const startEditing = (c) => { setEditingId(c.id); setEditName(c.name); setEditPolicy(c.policyText); };

            const openGenericSettings = () => {
                setEditingId('GENERIC_CONFIG');
                setEditPolicy(genericPolicy);
            };

            const saveCompany = () => {
                if (editingId === 'GENERIC_CONFIG') {
                    setGenericPolicy(editPolicy);
                    return;
                }

                if (!editName.trim()) return;
                const newCo = { id: editingId === 'NEW' ? Date.now().toString() : editingId, name: editName, policyText: editPolicy };
                if (editingId === 'NEW') {
                    setCompanies([...companies, newCo]);
                    setEditingId(newCo.id); setSelectedCompanyId(newCo.id);
                } else {
                    setCompanies(companies.map(c => c.id === editingId ? newCo : c));
                }
            };

            const deleteCompany = (id) => {
                setCompanies(companies.filter(c => c.id !== id));
                if (selectedCompanyId === id) setSelectedCompanyId(GENERIC_ID);
                setEditingId(null);
            };

            const openApiSettings = () => {
                setEditingId('API_CONFIG');
                setEditApiKey(apiKey);
            };

            const openCurrentPolicySettings = () => {
                setActiveTab('settings');
                if (selectedCompanyId === GENERIC_ID) {
                    openGenericSettings();
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    if (company) startEditing(company);
                }
            };

            const renderProviderBadge = () => {
                switch (activeProvider) {
                    case 'GROQ': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 text-[10px] font-bold border border-orange-200"><Rocket className="w-3 h-3" /><span>Groq</span></div>);
                    case 'OPENAI': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px] font-bold border border-green-200"><Zap className="w-3 h-3" /><span>OpenAI</span></div>);
                    case 'WEBLLM': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-[10px] font-bold border border-purple-200"><Cpu className="w-3 h-3" /><span>WebLLM (Lokal)</span></div>);
                    default: return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[10px] font-bold border border-slate-200"><Cpu className="w-3 h-3" /><span>Simulation</span></div>);
                }
            };

            const DUMMY_CLIPBOARD_CONTENT = `Betreff: Problem mit meiner Bestellung #12345

Hallo Support-Team,

ich habe vor 20 Tagen bei euch einen Monitor gekauft (Bestellung #12345). Leider flackert der Bildschirm ab und zu. Ich habe die Originalverpackung noch.
Kann ich das Gerät zurückschicken und bekomme ich mein Geld zurück? Oder muss ich den Versand selbst zahlen?

Viele Grüße,
Max Mustermann`;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('workspace')}>
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg text-white">
                                <Zap className="w-5 h-5" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    {t.title}
                                </h1>
                                <div className="mt-1">
                                    {renderProviderBadge()}
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            {activeTab === 'workspace' && (
                                <div className="relative hidden md:block">
                                    <select
                                        value={selectedCompanyId}
                                        onChange={(e) => setSelectedCompanyId(e.target.value)}
                                        className="appearance-none pl-9 bg-slate-100 border-none rounded-md pr-8 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer w-48 truncate"
                                    >
                                        <option value={GENERIC_ID}>{t.stdPolicy}</option>
                                        <optgroup label={t.shops}>
                                            {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </optgroup>
                                    </select>
                                    <Building2 className="w-4 h-4 text-slate-500 absolute left-3 top-2.5 pointer-events-none" />
                                </div>
                            )}

                            <div className="relative">
                                <select
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    className="appearance-none pl-9 bg-slate-100 border-none rounded-md pr-8 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer w-32"
                                >
                                    <option value="de">Deutsch 🇩🇪</option>
                                    <option value="en">English 🇺🇸</option>
                                    <option value="it">Italiano 🇮🇹</option>
                                    <option value="es">Español 🇪🇸</option>
                                    <option value="fr">Français 🇫🇷</option>
                                    <option value="nl">Nederlands 🇳🇱</option>
                                </select>
                                <Globe className="w-4 h-4 text-slate-500 absolute left-3 top-2.5 pointer-events-none" />
                            </div>

                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${activeTab === 'settings' ? 'bg-blue-50 text-blue-700' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                <Settings className="w-4 h-4" />
                                <span className="hidden sm:inline">{t.settings}</span>
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto p-4 md:p-6">
                        {errorMsg && (
                            <div className="mb-6 p-4 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl flex items-center gap-3 shadow-sm animate-in fade-in slide-in-from-top-2">
                                <div className="p-2 bg-amber-100 rounded-full"><WifiOff className="w-4 h-4" /></div>
                                <div className="flex-1">
                                    <p className="font-semibold text-sm">Hinweis</p>
                                    <p className="text-xs opacity-90">{errorMsg}</p>
                                </div>
                                <button onClick={() => setErrorMsg('')} className="ml-auto text-amber-400 hover:text-amber-700"><X className="w-4 h-4" /></button>
                            </div>
                        )}

                        {activeTab === 'workspace' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                                <div className="flex flex-col gap-6">
                                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[500px] relative transition-all focus-within:ring-2 ring-blue-100">
                                        <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center min-h-[50px]">
                                            <div className="flex items-center gap-2 text-slate-700 font-medium">
                                                <Mail className="w-4 h-4 text-blue-500" />
                                                <h3>{t.incoming}</h3>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <button
                                                    onClick={handlePasteInput}
                                                    className="text-slate-500 hover:text-blue-600 hover:bg-slate-100 p-2 rounded-md transition-colors flex items-center gap-2 text-xs font-medium"
                                                    title="Aus Zwischenablage einfügen"
                                                >
                                                    <Clipboard className="w-4 h-4" />
                                                    <span className="hidden xl:inline">{t.paste}</span>
                                                </button>

                                                {incomingMail && (
                                                    <button
                                                        onClick={handleCopyInput}
                                                        className={`p-2 rounded-md transition-all flex items-center gap-2 text-xs font-medium ${inputCopySuccess ? 'bg-green-100 text-green-700' : 'text-slate-500 hover:text-blue-600 hover:bg-slate-100'}`}
                                                        title="Text kopieren"
                                                    >
                                                        {inputCopySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                                    </button>
                                                )}

                                                <div className="h-4 w-px bg-slate-200 mx-1"></div>

                                                <button
                                                    onClick={handleReset}
                                                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md transition-all text-xs font-medium ${confirmReset ? 'bg-red-100 text-red-700 w-auto' : 'text-slate-500 hover:text-red-600 hover:bg-red-50'}`}
                                                    title="Alles zurücksetzen"
                                                >
                                                    {confirmReset ? (
                                                        <>
                                                            <AlertTriangle className="w-3.5 h-3.5" />
                                                            {t.confirmReset}
                                                        </>
                                                    ) : (
                                                        <>
                                                            <RotateCcw className="w-3.5 h-3.5" />
                                                            <span className="hidden xl:inline">{t.reset}</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>

                                        {pasteError && (
                                            <div className="absolute top-[60px] left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-full shadow-lg z-10 animate-in fade-in slide-in-from-top-1">
                                                Bitte mit Strg+V einfügen (Browser blockiert Button)
                                            </div>
                                        )}

                                        <textarea
                                            className="flex-1 p-5 resize-y focus:outline-none text-slate-600 text-base leading-relaxed"
                                            placeholder={t.inputPlaceholder}
                                            value={incomingMail}
                                            onChange={(e) => setIncomingMail(e.target.value)}
                                        />

                                        {!incomingMail && (
                                            <div className="absolute bottom-4 right-4">
                                                <button onClick={() => { setIncomingMail(DUMMY_CLIPBOARD_CONTENT); setTimeout(() => document.getElementById('gen-btn')?.click(), 100); }} className="text-xs bg-slate-50 text-slate-400 border border-slate-200 px-2 py-1 rounded hover:bg-slate-100 transition-colors">
                                                    {t.demo}
                                                </button>
                                            </div>
                                        )}
                                    </section>

                                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col flex-1 min-h-[200px] transition-all focus-within:ring-2 ring-emerald-100">
                                        <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                                            <div className="flex items-center gap-2 text-slate-700 font-medium">
                                                <FileText className="w-4 h-4 text-emerald-500" />
                                                <h3 className="truncate text-sm">
                                                    {selectedCompanyId === GENERIC_ID ? t.stdPolicy : companies.find(c => c.id === selectedCompanyId)?.name}
                                                </h3>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    <FilePenLine className="w-3 h-3" />
                                                    {t.directEdit}
                                                </span>
                                                <div className="h-3 w-px bg-slate-200"></div>
                                                <button
                                                    onClick={openCurrentPolicySettings}
                                                    className="text-slate-400 hover:text-blue-600 p-1 rounded transition-colors"
                                                    title="Erweiterte Einstellungen öffnen"
                                                >
                                                    <Settings className="w-3.5 h-3.5" />
                                                </button>
                                            </div>
                                        </div>
                                        <textarea
                                            className="flex-1 w-full h-full p-4 bg-white resize-y outline-none font-mono text-xs text-slate-600 hover:bg-white focus:bg-white transition-colors border-none"
                                            value={policyContent}
                                            onChange={(e) => handlePolicyChange(e.target.value)}
                                            spellCheck={false}
                                            placeholder={t.policyPlaceholder}
                                        />
                                    </section>
                                </div>

                                <div className="flex flex-col gap-6">
                                    <section className="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden flex flex-col h-full relative">
                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                                            <div className="flex items-center gap-2 text-blue-900 font-bold">
                                                <Sparkles className="w-4 h-4 text-blue-600" />
                                                <h3>{t.aiResponse}</h3>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {usedFallback && (
                                                    <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                                        <Cpu className="w-3 h-3" /> {t.fallback}
                                                    </span>
                                                )}
                                                {renderProviderBadge()}
                                            </div>
                                        </div>

                                        <div className="flex-1 relative bg-white flex flex-col">
                                            {isGenerating && (
                                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/95 z-20 backdrop-blur-sm">
                                                    <div className="w-10 h-10 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                                    <p className="text-slate-600 text-sm font-medium animate-pulse">
                                                        {activeProvider === 'WEBLLM'
                                                            ? (webLLMProgress || 'Lade KI-Modell (einmalig)...')
                                                            : activeProvider === 'GROQ' ? 'Groq generiert (Llama 3.3)...' : activeProvider === 'OPENAI' ? 'OpenAI generiert...' : 'Simuliere...'}
                                                    </p>
                                                </div>
                                            )}
                                            <textarea
                                                className={`flex-1 w-full p-6 resize-y focus:outline-none text-slate-700 leading-relaxed text-base transition-colors ${manualEditMode ? 'bg-white' : 'bg-slate-50/30'}`}
                                                placeholder={t.responsePlaceholder}
                                                value={generatedResponse}
                                                onChange={(e) => { setGeneratedResponse(e.target.value); setManualEditMode(true); }}
                                            />

                                            <div className="px-4 py-3 bg-slate-50 border-t border-slate-100">
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        placeholder={t.instrPlaceholder}
                                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
                                                        value={customInstruction}
                                                        onChange={(e) => setCustomInstruction(e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && generateResponse(customInstruction)}
                                                    />
                                                    <button
                                                        id="gen-btn"
                                                        onClick={() => generateResponse(customInstruction)}
                                                        disabled={!incomingMail || isGenerating}
                                                        className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 p-2 rounded-lg disabled:opacity-50 transition-colors shadow-sm"
                                                    >
                                                        <ArrowRight className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-white border-t border-slate-100 flex gap-4">
                                            <button onClick={() => generateResponse()} disabled={!incomingMail} className="px-4 py-3 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-300 transition-colors shadow-sm">
                                                <RefreshCw className="w-4 h-4" />
                                            </button>
                                            {generatedResponse && (
                                                <button onClick={handleCopy} className={`flex-1 flex items-center justify-center gap-2 rounded-lg font-bold transition-all shadow-md ${copySuccess ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                                    {copySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                                    {copySuccess ? t.copied : t.copy}
                                                </button>
                                            )}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="bg-slate-50 border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-200 flex flex-col gap-4 bg-white">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Settings className="w-4 h-4" /> Verwaltung
                                        </h2>

                                        <button
                                            onClick={openApiSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'API_CONFIG' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <Key className="w-4 h-4" />
                                            KI & API Konfiguration
                                        </button>

                                        <button
                                            onClick={openGenericSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'GENERIC_CONFIG' ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <FileText className="w-4 h-4" />
                                            Standard-Richtlinien
                                        </button>
                                    </div>

                                    <div className="p-2 bg-slate-50">
                                        <div className="flex justify-between items-center px-2 py-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t.shops}</span>
                                            <button onClick={startAdding} className="bg-white border border-slate-200 p-1 rounded hover:bg-blue-50 hover:border-blue-200 text-blue-600"><Plus className="w-3 h-3" /></button>
                                        </div>
                                        <div className="space-y-1 overflow-y-auto max-h-[400px]">
                                            {companies.map(c => (
                                                <button
                                                    key={c.id}
                                                    onClick={() => startEditing(c)}
                                                    className={`w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center gap-2 ${editingId === c.id ? 'bg-white shadow-sm text-blue-700 font-medium' : 'text-slate-600 hover:bg-slate-200'}`}
                                                >
                                                    <Building2 className="w-3 h-3 opacity-50" />
                                                    <span className="truncate">{c.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-auto p-4 border-t border-slate-200 flex flex-col gap-2">
                                        <div className="text-xs text-slate-400 px-1 truncate flex justify-between items-center">
                                            <span>User: <span className="font-medium text-slate-600">{currentUser?.username}</span></span>
                                        </div>
                                        <button
                                            onClick={handleLogout}
                                            className="w-full py-2 px-3 text-xs rounded border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <LogOut className="w-3 h-3" /> {t.logout}
                                        </button>
                                        <button
                                            onClick={handleFactoryReset}
                                            className={`w-full py-2 px-3 text-xs rounded border transition-colors flex items-center justify-center gap-2 ${confirmReset ? 'bg-red-600 text-white border-red-700' : 'text-red-500 hover:bg-red-50 border-transparent hover:border-red-100'}`}
                                        >
                                            {confirmReset ? (
                                                <>{t.confirmAppReset}</>
                                            ) : (
                                                <><RotateCcw className="w-3 h-3" /> {t.appReset}</>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                <div className="md:col-span-2 p-6 flex flex-col h-full overflow-y-auto">
                                    {editingId === 'API_CONFIG' ? (
                                        <div className="space-y-6">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">API Konfiguration</h2></div>
                                            <div className="bg-slate-50 p-4 rounded text-sm text-slate-600 border border-slate-200">
                                                <div className="flex items-center gap-2 mb-2 font-bold">
                                                    {t.activeMode}: {renderProviderBadge()}
                                                </div>
                                                <p className="text-xs text-slate-500 mb-1">
                                                    {t.providerInfo}
                                                </p>
                                                <ul className="list-disc list-inside text-xs space-y-1 ml-1">
                                                    <li><code>gsk_...</code> → <strong>Groq</strong> (Llama 3.3) - <em>Extrem schnell</em></li>
                                                    <li><code>webllm</code> → <strong>WebLLM</strong> (Lokal im Browser)</li>
                                                    <li><code>sk-...</code> → <strong>OpenAI</strong> (GPT-3.5/4) - <em>Standard</em></li>
                                                    <li>(Leer) → <strong>Simulation</strong> (Offline)</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">{t.apiKey}</label>
                                                <input
                                                    type="password"
                                                    value={editApiKey}
                                                    onChange={e => setEditApiKey(e.target.value)}
                                                    className="w-full border p-2 rounded focus:ring-2 ring-indigo-500 outline-none font-mono text-sm"
                                                    placeholder="gsk_... oder sk-..."
                                                />
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => { setApiKey(editApiKey); alert(t.save + '!'); }} className="bg-indigo-600 text-white px-4 py-2 rounded self-start flex items-center gap-2 hover:bg-indigo-700 transition-colors"><Save className="w-4 h-4" /> {t.save}</button>
                                                <button onClick={() => { setApiKey('webllm'); setEditApiKey('webllm'); }} className="bg-purple-600 text-white px-4 py-2 rounded self-start flex items-center gap-2 hover:bg-purple-700 transition-colors"><Cpu className="w-4 h-4" /> Offline-KI aktivieren</button>
                                            </div>
                                        </div>
                                    ) : editingId === 'GENERIC_CONFIG' ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">{t.stdPolicy}</h2></div>
                                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded text-sm text-emerald-800">
                                                {t.genPolicyDefault.split('\n')[0]}
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">{t.stdPolicy}</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-emerald-500 outline-none resize-y min-h-[300px]" />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-emerald-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-emerald-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> {t.save}
                                                </button>
                                            </div>
                                        </div>
                                    ) : editingId ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4 flex justify-between items-center">
                                                <h2 className="text-lg font-bold">{editingId === 'NEW' ? t.newShop : t.editShop}</h2>
                                                {editingId !== 'NEW' && <button onClick={() => deleteCompany(editingId)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">{t.name}</label>
                                                <input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="w-full border p-2 rounded focus:ring-2 ring-blue-500 outline-none" placeholder="Shop Name" />
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">{t.policyLabel}</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-blue-500 outline-none resize-y min-h-[300px]" placeholder="Regeln hier..." />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-blue-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> {t.save}
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-300">
                                            <Settings className="w-16 h-16 mb-4 opacity-20" />
                                            <p>Wählen Sie links einen Shop oder die Konfiguration aus.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>