<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartReply Assistent</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Error Overlay Style */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            z-index: 9999;
            overflow: auto;
            font-family: monospace;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-50">
    <div id="error-overlay"></div>
    <div id="root"></div>

    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            const div = document.getElementById('error-overlay');
            div.style.display = 'block';
            div.innerHTML = `<h3>Kritischer Fehler</h3><p>${msg}</p><pre>${url}:${line}:${col}</pre><pre>${error && error.stack}</pre>`;
        };
    </script>

    <script type="text/babel" data-presets="env,react">
        // --- React Imports ---
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Icon Components (Lucide Mock) ---
        const IconBase = ({ children, className = "w-4 h-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Mail = p => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></IconBase>;
        const FileText = p => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconBase>;
        const Copy = p => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></IconBase>;
        const Sparkles = p => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></IconBase>;
        const Settings = p => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Check = p => <IconBase {...p}><polyline points="20 6 9 17 4 12" /></IconBase>;
        const Clipboard = p => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /></IconBase>;
        const ArrowRight = p => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></IconBase>;
        const Zap = p => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const RefreshCw = p => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>;
        const Plus = p => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>;
        const Trash2 = p => <IconBase {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const Save = p => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Building2 = p => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" /><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" /><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" /><path d="M10 6h4" /><path d="M10 10h4" /><path d="M10 14h4" /><path d="M10 18h4" /></IconBase>;
        const RotateCcw = p => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>;
        const Key = p => <IconBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></IconBase>;
        const AlertTriangle = p => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const X = p => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>;
        const Cpu = p => <IconBase {...p}><rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M15 2v2" /><path d="M15 20v2" /><path d="M2 15h2" /><path d="M2 9h2" /><path d="M20 15h2" /><path d="M20 9h2" /><path d="M9 2v2" /><path d="M9 20v2" /></IconBase>;
        const Rocket = p => <IconBase {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" /><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" /><path d="M9 12H4s.55-3.03 2-4c1.62-1.1 4-1 4-1s-1.07 1.83-1 4z" /><path d="M12 15v5s3.03-.55 4-2c1.1-1.62 1-4 1-4s-1.83 1.07-4 1z" /></IconBase>;
        const FilePenLine = p => <IconBase {...p}><path d="m18 5-3-3H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2" /><path d="M8 18h1" /><path d="M18.4 2.6a2.17 2.17 0 0 1 3 3L16 11l-4 1 1-4Z" /></IconBase>;
        const WifiOff = p => <IconBase {...p}><line x1="2" y1="2" x2="22" y2="22" /><path d="M8.5 8.5A10 10 0 0 1 22 12" /><path d="M5 12a7 7 0 0 1 7-7 7 7 0 0 1 7 7" /><path d="M8.52 16.48A4 4 0 0 1 12 16c1.1 0 2.1.4 2.9 1.1" /><path d="M12 20h.01" /></IconBase>;


        const GENERIC_ID = 'general';
        const GENERIC_POLICY_TEXT = `ALLGEMEINE STANDARD-RICHTLINIE:
- Tonalität: Professionell, höflich und lösungsorientiert.
- Anrede: "Sie" (Standard), es sei denn der Kunde duzt offensichtlich.
- Ziel: Beantworte die Anfrage direkt und präzise.
- LÄNGE: Halte dich kurz. Maximal 2-4 Absätze.
- INHALT: Gib allgemeine Informationen, keine spezifischen Details erfinden.`;

        const DEFAULT_TEST_KEY = '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';

        const DEFAULT_COMPANIES = [
            {
                id: 'c1',
                name: 'TechNova GmbH',
                policyText: `RÜCKGABERICHTLINIEN:
- Rückgabefrist beträgt 30 Tage nach Kaufdatum.
- Artikel müssen originalverpackt sein.
- Bei Defekten übernehmen wir die Versandkosten.
- Rückerstattung erfolgt auf das ursprüngliche Zahlungsmittel innerhalb von 5 Werktagen.

TONALITY:
- Professionell, aber freundlich.
- "Du" oder "Sie" je nach Kundenanrede (Standard: Sie).
- Immer eine Ticket-ID angeben.`
            },
            {
                id: 'c2',
                name: 'Fashion Boutique',
                policyText: `UMTAUSCH:
- Nur gegen Gutschein oder andere Größe.
- Keine Barauszahlung.
- Getragene Kleidung ist vom Umtausch ausgeschlossen.
- Sale-Artikel sind finaler Verkauf (kein Umtausch).

TONALITY:
- Sehr persönlich, emotional, modebewusst.
- Immer "Du".
- Emojis sind erlaubt.`
            }
        ];

        // --- Helper: Robust Copy ---
        const robustCopyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                        resolve();
                    } catch (error) {
                        textArea.remove();
                        reject(error);
                    }
                });
            }
        };

        // --- Main Component ---
        function App() {
            // --- Persistent State ---
            const [companies, setCompanies] = useState(() => {
                const saved = localStorage.getItem('smart_reply_companies');
                return saved ? JSON.parse(saved) : DEFAULT_COMPANIES;
            });

            const [selectedCompanyId, setSelectedCompanyId] = useState(() => {
                return localStorage.getItem('smart_reply_last_company') || GENERIC_ID;
            });

            const [apiKey, setApiKey] = useState(() => {
                return localStorage.getItem('smart_reply_api_key') || DEFAULT_TEST_KEY;
            });

            const [genericPolicy, setGenericPolicy] = useState(() => {
                return localStorage.getItem('smart_reply_generic_policy') || GENERIC_POLICY_TEXT;
            });

            // --- Runtime State ---
            const [activeTab, setActiveTab] = useState('workspace');
            const [incomingMail, setIncomingMail] = useState('');
            const [policyContent, setPolicyContent] = useState('');

            const [generatedResponse, setGeneratedResponse] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [customInstruction, setCustomInstruction] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [usedFallback, setUsedFallback] = useState(false);

            const [copySuccess, setCopySuccess] = useState(false);
            const [inputCopySuccess, setInputCopySuccess] = useState(false);
            const [manualEditMode, setManualEditMode] = useState(false);
            const [confirmReset, setConfirmReset] = useState(false);
            const [pasteError, setPasteError] = useState(false);

            // --- Settings UI State ---
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPolicy, setEditPolicy] = useState('');
            const [editApiKey, setEditApiKey] = useState('');

            // --- Helper: Detect Provider ---
            const getProvider = (key) => {
                if (key.startsWith('gsk_')) return 'GROQ';
                if (key.startsWith('sk-')) return 'OPENAI';
                return 'SIMULATION';
            };

            const activeProvider = getProvider(apiKey);

            // --- Effects ---
            useEffect(() => { localStorage.setItem('smart_reply_companies', JSON.stringify(companies)); }, [companies]);
            useEffect(() => { localStorage.setItem('smart_reply_last_company', selectedCompanyId); }, [selectedCompanyId]);
            useEffect(() => { localStorage.setItem('smart_reply_api_key', apiKey); setEditApiKey(apiKey); }, [apiKey]);
            useEffect(() => { localStorage.setItem('smart_reply_generic_policy', genericPolicy); }, [genericPolicy]);

            useEffect(() => {
                if (selectedCompanyId === GENERIC_ID) {
                    setPolicyContent(genericPolicy);
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    setPolicyContent(company ? company.policyText : genericPolicy);
                }
            }, [selectedCompanyId, activeTab]);

            useEffect(() => {
                if (confirmReset) {
                    const timer = setTimeout(() => setConfirmReset(false), 3000);
                    return () => clearTimeout(timer);
                }
            }, [confirmReset]);

            // --- Handlers: Logic ---
            const handlePolicyChange = (newText) => {
                setPolicyContent(newText);
                if (selectedCompanyId === GENERIC_ID) {
                    setGenericPolicy(newText);
                } else {
                    setCompanies(prev => prev.map(c =>
                        c.id === selectedCompanyId ? { ...c, policyText: newText } : c
                    ));
                }
            };

            const generateResponse = async (instruction) => {
                setIsGenerating(true);
                setManualEditMode(false);
                setErrorMsg('');
                setUsedFallback(false);
                setGeneratedResponse('');

                const company = companies.find(c => c.id === selectedCompanyId);
                const companyName = company ? company.name : 'Unser Unternehmen';
                const isGeneric = selectedCompanyId === GENERIC_ID;
                const currentPolicyText = policyContent;

                const systemPrompt = `Du bist ein Kundensupport-Agent für "${companyName}".
RICHTLINIEN:
${currentPolicyText}
${isGeneric ? "WICHTIG: Fasse dich kurz (max. 2-4 Absätze). Gib allgemeine Informationen." : ""}

AUFGABE:
Antworte dem Kunden professionell, empathisch und lösungsorientiert.
Beachte die Richtlinien genau.
Antworte NUR mit dem E-Mail-Text, ohne Einleitung wie "Hier ist ein Entwurf".`;

                const userPrompt = `Kunden-Email:
"""
${incomingMail}
"""

${instruction ? 'Zusatz-Anweisung: ' + instruction : ''}`;

                try {
                    if (activeProvider === 'GROQ') {
                        await callGroqAI(userPrompt, systemPrompt);
                    } else if (activeProvider === 'OPENAI') {
                        await callOpenAI(userPrompt, systemPrompt);
                    } else {
                        await runSimulation(companyName, instruction);
                    }
                } catch (err) {
                    console.error("API Call Failed:", err);
                    let friendlyError = "Ein unbekannter Fehler ist aufgetreten.";
                    if (err.message && (err.message.includes("Failed to fetch") || err.name === 'TypeError')) {
                        // CORS or Network error
                        friendlyError = "Verbindung bei API blockiert (Netzwerk/CORS). Nutze Fallback.";
                    } else {
                        friendlyError = `API Fehler: ${err.message || err}. Nutze Fallback.`;
                    }

                    setErrorMsg(friendlyError);
                    setUsedFallback(true);
                    await runSimulation(companyName, instruction);
                } finally {
                    setIsGenerating(false);
                }
            };

            const callGroqAI = async (prompt, systemContext) => {
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        // mode: 'cors' is default, explicit helps debug
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                            temperature: 0.7,
                        })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error?.message || `Groq API Error (${response.status})`);
                    }
                    const data = await response.json();
                    setGeneratedResponse(data.choices[0]?.message?.content || "");
                } catch (e) {
                    throw e;
                }
            };

            const callOpenAI = async (prompt, systemContext) => {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                        temperature: 0.7,
                    })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
                const data = await response.json();
                setGeneratedResponse(data.choices[0]?.message?.content || "");
            };

            const runSimulation = async (companyName, instruction) => {
                await new Promise(r => setTimeout(r, 800));

                if (selectedCompanyId === GENERIC_ID) {
                    setGeneratedResponse(`Sehr geehrte Damen und Herren,

vielen Dank für Ihre Nachricht. Wir haben Ihr Anliegen erhalten und werden es schnellstmöglich prüfen.

Da es sich um eine allgemeine Anfrage handelt, melden wir uns in Kürze mit weiteren Informationen bei Ihnen. Sollten Sie in der Zwischenzeit weitere Fragen haben, stehen wir Ihnen gerne zur Verfügung.

Mit freundlichen Grüßen,
Ihr Support-Team`);
                    return;
                }

                let isDu = policyContent.toLowerCase().includes('immer "du"');
                const hasName = incomingMail.includes('Mustermann');
                const customerName = hasName ? (isDu ? 'Max' : 'Herr Mustermann') : 'Kunde';

                let body = isDu
                    ? `danke für deine Nachricht. Wir kümmern uns darum! ${instruction ? instruction : ''}`
                    : `vielen Dank für Ihre Nachricht. Wir haben Ihr Anliegen erfasst. ${instruction ? instruction : ''}`;

                if (!instruction && !isDu) {
                    body += " Basierend auf Ihren Angaben werden wir den Vorgang prüfen und uns zeitnah mit einer Lösung bei Ihnen melden.";
                }

                setGeneratedResponse(`${isDu ? 'Hallo' : 'Guten Tag'} ${customerName},

${body}

${isDu ? 'Viele Grüße' : 'Mit freundlichen Grüßen'},
Ihr Support-Team`);
            };

            // --- Handlers ---
            const handleCopy = () => {
                robustCopyToClipboard(generatedResponse)
                    .then(() => {
                        setCopySuccess(true);
                        setTimeout(() => setCopySuccess(false), 2000);
                    })
                    .catch(() => alert('Kopieren fehlgeschlagen'));
            };

            const handleCopyInput = () => {
                robustCopyToClipboard(incomingMail)
                    .then(() => {
                        setInputCopySuccess(true);
                        setTimeout(() => setInputCopySuccess(false), 2000);
                    });
            };

            const handlePasteInput = async () => {
                setPasteError(false);
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) setIncomingMail(text);
                } catch (err) {
                    setPasteError(true);
                    setTimeout(() => setPasteError(false), 4000);
                }
            };

            const handleReset = () => {
                if (!confirmReset) {
                    setConfirmReset(true);
                } else {
                    setIncomingMail('');
                    setGeneratedResponse('');
                    setCustomInstruction('');
                    setManualEditMode(false);
                    setErrorMsg('');
                    setUsedFallback(false);
                    setCopySuccess(false);
                    setInputCopySuccess(false);
                    setConfirmReset(false);
                }
            };

            const handleFactoryReset = () => {
                if (confirmReset) {
                    localStorage.clear();
                    window.location.reload();
                } else {
                    setConfirmReset(true);
                }
            };

            // --- Settings Handlers ---
            const startAdding = () => { setEditingId('NEW'); setEditName('Neuer Shop'); setEditPolicy(''); };
            const startEditing = (c) => { setEditingId(c.id); setEditName(c.name); setEditPolicy(c.policyText); };

            const openGenericSettings = () => {
                setEditingId('GENERIC_CONFIG');
                setEditPolicy(genericPolicy);
            };

            const saveCompany = () => {
                if (editingId === 'GENERIC_CONFIG') {
                    setGenericPolicy(editPolicy);
                    return;
                }

                if (!editName.trim()) return;
                const newCo = { id: editingId === 'NEW' ? Date.now().toString() : editingId, name: editName, policyText: editPolicy };
                if (editingId === 'NEW') {
                    setCompanies([...companies, newCo]);
                    setEditingId(newCo.id); setSelectedCompanyId(newCo.id);
                } else {
                    setCompanies(companies.map(c => c.id === editingId ? newCo : c));
                }
            };

            const deleteCompany = (id) => {
                setCompanies(companies.filter(c => c.id !== id));
                if (selectedCompanyId === id) setSelectedCompanyId(GENERIC_ID);
                setEditingId(null);
            };

            const openApiSettings = () => {
                setEditingId('API_CONFIG');
                setEditApiKey(apiKey);
            };

            const openCurrentPolicySettings = () => {
                setActiveTab('settings');
                if (selectedCompanyId === GENERIC_ID) {
                    openGenericSettings();
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    if (company) startEditing(company);
                }
            };

            const renderProviderBadge = () => {
                switch (activeProvider) {
                    case 'GROQ': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 text-[10px] font-bold border border-orange-200"><Rocket className="w-3 h-3" /><span>Groq</span></div>);
                    case 'OPENAI': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px] font-bold border border-green-200"><Zap className="w-3 h-3" /><span>OpenAI</span></div>);
                    default: return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[10px] font-bold border border-slate-200"><Cpu className="w-3 h-3" /><span>Simulation</span></div>);
                }
            };

            const DUMMY_CLIPBOARD_CONTENT = `Betreff: Problem mit meiner Bestellung #12345

Hallo Support-Team,

ich habe vor 20 Tagen bei euch einen Monitor gekauft (Bestellung #12345). Leider flackert der Bildschirm ab und zu. Ich habe die Originalverpackung noch.
Kann ich das Gerät zurückschicken und bekomme ich mein Geld zurück? Oder muss ich den Versand selbst zahlen?

Viele Grüße,
Max Mustermann`;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('workspace')}>
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg text-white">
                                <Zap className="w-5 h-5" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    SmartReply
                                </h1>
                                <div className="mt-1">
                                    {renderProviderBadge()}
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            {activeTab === 'workspace' && (
                                <div className="relative hidden md:block">
                                    <select
                                        value={selectedCompanyId}
                                        onChange={(e) => setSelectedCompanyId(e.target.value)}
                                        className="appearance-none pl-9 bg-slate-100 border-none rounded-md pr-8 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer w-48 truncate"
                                    >
                                        <option value={GENERIC_ID}>Allgemein (Standard)</option>
                                        <optgroup label="Meine Shops">
                                            {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </optgroup>
                                    </select>
                                    <Building2 className="w-4 h-4 text-slate-500 absolute left-3 top-2.5 pointer-events-none" />
                                </div>
                            )}

                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${activeTab === 'settings' ? 'bg-blue-50 text-blue-700' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                <Settings className="w-4 h-4" />
                                <span className="hidden sm:inline">Einstellungen</span>
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto p-4 md:p-6">
                        {errorMsg && (
                            <div className="mb-6 p-4 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl flex items-center gap-3 shadow-sm animate-in fade-in slide-in-from-top-2">
                                <div className="p-2 bg-amber-100 rounded-full"><WifiOff className="w-4 h-4" /></div>
                                <div className="flex-1">
                                    <p className="font-semibold text-sm">Hinweis</p>
                                    <p className="text-xs opacity-90">{errorMsg}</p>
                                </div>
                                <button onClick={() => setErrorMsg('')} className="ml-auto text-amber-400 hover:text-amber-700"><X className="w-4 h-4" /></button>
                            </div>
                        )}

                        {activeTab === 'workspace' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                                <div className="flex flex-col gap-6">
                                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[500px] relative transition-all focus-within:ring-2 ring-blue-100">
                                        <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center min-h-[50px]">
                                            <div className="flex items-center gap-2 text-slate-700 font-medium">
                                                <Mail className="w-4 h-4 text-blue-500" />
                                                <h3>Eingehende Nachricht</h3>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <button
                                                    onClick={handlePasteInput}
                                                    className="text-slate-500 hover:text-blue-600 hover:bg-slate-100 p-2 rounded-md transition-colors flex items-center gap-2 text-xs font-medium"
                                                    title="Aus Zwischenablage einfügen"
                                                >
                                                    <Clipboard className="w-4 h-4" />
                                                    <span className="hidden xl:inline">Einfügen</span>
                                                </button>

                                                {incomingMail && (
                                                    <button
                                                        onClick={handleCopyInput}
                                                        className={`p-2 rounded-md transition-all flex items-center gap-2 text-xs font-medium ${inputCopySuccess ? 'bg-green-100 text-green-700' : 'text-slate-500 hover:text-blue-600 hover:bg-slate-100'}`}
                                                        title="Text kopieren"
                                                    >
                                                        {inputCopySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                                    </button>
                                                )}

                                                <div className="h-4 w-px bg-slate-200 mx-1"></div>

                                                <button
                                                    onClick={handleReset}
                                                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md transition-all text-xs font-medium ${confirmReset ? 'bg-red-100 text-red-700 w-auto' : 'text-slate-500 hover:text-red-600 hover:bg-red-50'}`}
                                                    title="Alles zurücksetzen"
                                                >
                                                    {confirmReset ? (
                                                        <>
                                                            <AlertTriangle className="w-3.5 h-3.5" />
                                                            Wirklich löschen?
                                                        </>
                                                    ) : (
                                                        <>
                                                            <RotateCcw className="w-3.5 h-3.5" />
                                                            <span className="hidden xl:inline">Reset</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>

                                        {pasteError && (
                                            <div className="absolute top-[60px] left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-full shadow-lg z-10 animate-in fade-in slide-in-from-top-1">
                                                Bitte mit Strg+V einfügen (Browser blockiert Button)
                                            </div>
                                        )}

                                        <textarea
                                            className="flex-1 p-5 resize-none focus:outline-none text-slate-600 text-base leading-relaxed"
                                            placeholder="Fügen Sie hier die E-Mail des Kunden ein..."
                                            value={incomingMail}
                                            onChange={(e) => setIncomingMail(e.target.value)}
                                        />

                                        {!incomingMail && (
                                            <div className="absolute bottom-4 right-4">
                                                <button onClick={() => { setIncomingMail(DUMMY_CLIPBOARD_CONTENT); setTimeout(() => document.getElementById('gen-btn')?.click(), 100); }} className="text-xs bg-slate-50 text-slate-400 border border-slate-200 px-2 py-1 rounded hover:bg-slate-100 transition-colors">
                                                    Demo Text laden
                                                </button>
                                            </div>
                                        )}
                                    </section>

                                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col flex-1 min-h-[200px] transition-all focus-within:ring-2 ring-emerald-100">
                                        <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                                            <div className="flex items-center gap-2 text-slate-700 font-medium">
                                                <FileText className="w-4 h-4 text-emerald-500" />
                                                <h3 className="truncate text-sm">
                                                    {selectedCompanyId === GENERIC_ID ? 'Standard-Richtlinien' : companies.find(c => c.id === selectedCompanyId)?.name}
                                                </h3>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    <FilePenLine className="w-3 h-3" />
                                                    Direkt bearbeitbar
                                                </span>
                                                <div className="h-3 w-px bg-slate-200"></div>
                                                <button
                                                    onClick={openCurrentPolicySettings}
                                                    className="text-slate-400 hover:text-blue-600 p-1 rounded transition-colors"
                                                    title="Erweiterte Einstellungen öffnen"
                                                >
                                                    <Settings className="w-3.5 h-3.5" />
                                                </button>
                                            </div>
                                        </div>
                                        <textarea
                                            className="flex-1 w-full h-full p-4 bg-white resize-none outline-none font-mono text-xs text-slate-600 hover:bg-white focus:bg-white transition-colors border-none"
                                            value={policyContent}
                                            onChange={(e) => handlePolicyChange(e.target.value)}
                                            spellCheck={false}
                                            placeholder="Hier Richtlinien anpassen..."
                                        />
                                    </section>
                                </div>

                                <div className="flex flex-col gap-6">
                                    <section className="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden flex flex-col h-full relative">
                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                                            <div className="flex items-center gap-2 text-blue-900 font-bold">
                                                <Sparkles className="w-4 h-4 text-blue-600" />
                                                <h3>KI-Antwort</h3>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {usedFallback && (
                                                    <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                                        <Cpu className="w-3 h-3" /> Fallback aktiv
                                                    </span>
                                                )}
                                                {renderProviderBadge()}
                                            </div>
                                        </div>

                                        <div className="flex-1 relative bg-white flex flex-col">
                                            {isGenerating && (
                                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/95 z-20 backdrop-blur-sm">
                                                    <div className="w-10 h-10 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                                    <p className="text-slate-600 text-sm font-medium animate-pulse">
                                                        {activeProvider === 'GROQ' ? 'Groq generiert (Llama 3.3)...' : activeProvider === 'OPENAI' ? 'OpenAI generiert...' : 'Simuliere...'}
                                                    </p>
                                                </div>
                                            )}
                                            <textarea
                                                className={`flex-1 w-full p-6 resize-none focus:outline-none text-slate-700 leading-relaxed text-base transition-colors ${manualEditMode ? 'bg-white' : 'bg-slate-50/30'}`}
                                                placeholder="Die Antwort erscheint hier..."
                                                value={generatedResponse}
                                                onChange={(e) => { setGeneratedResponse(e.target.value); setManualEditMode(true); }}
                                            />

                                            <div className="px-4 py-3 bg-slate-50 border-t border-slate-100">
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        placeholder='Z.B. "Biete 5% Rabatt an" oder "Fasse dich kürzer"'
                                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
                                                        value={customInstruction}
                                                        onChange={(e) => setCustomInstruction(e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && generateResponse(customInstruction)}
                                                    />
                                                    <button
                                                        id="gen-btn"
                                                        onClick={() => generateResponse(customInstruction)}
                                                        disabled={!incomingMail || isGenerating}
                                                        className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 p-2 rounded-lg disabled:opacity-50 transition-colors shadow-sm"
                                                    >
                                                        <ArrowRight className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-white border-t border-slate-100 flex gap-4">
                                            <button onClick={() => generateResponse()} disabled={!incomingMail} className="px-4 py-3 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-300 transition-colors shadow-sm">
                                                <RefreshCw className="w-4 h-4" />
                                            </button>
                                            {generatedResponse && (
                                                <button onClick={handleCopy} className={`flex-1 flex items-center justify-center gap-2 rounded-lg font-bold transition-all shadow-md ${copySuccess ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                                    {copySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                                    {copySuccess ? 'Kopiert' : 'Kopieren'}
                                                </button>
                                            )}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="bg-slate-50 border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-200 flex flex-col gap-4 bg-white">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Settings className="w-4 h-4" /> Verwaltung
                                        </h2>

                                        <button
                                            onClick={openApiSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'API_CONFIG' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <Key className="w-4 h-4" />
                                            KI & API Konfiguration
                                        </button>

                                        <button
                                            onClick={openGenericSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'GENERIC_CONFIG' ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <FileText className="w-4 h-4" />
                                            Standard-Richtlinien
                                        </button>
                                    </div>

                                    <div className="p-2 bg-slate-50">
                                        <div className="flex justify-between items-center px-2 py-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Shops</span>
                                            <button onClick={startAdding} className="bg-white border border-slate-200 p-1 rounded hover:bg-blue-50 hover:border-blue-200 text-blue-600"><Plus className="w-3 h-3" /></button>
                                        </div>
                                        <div className="space-y-1 overflow-y-auto max-h-[400px]">
                                            {companies.map(c => (
                                                <button
                                                    key={c.id}
                                                    onClick={() => startEditing(c)}
                                                    className={`w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center gap-2 ${editingId === c.id ? 'bg-white shadow-sm text-blue-700 font-medium' : 'text-slate-600 hover:bg-slate-200'}`}
                                                >
                                                    <Building2 className="w-3 h-3 opacity-50" />
                                                    <span className="truncate">{c.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-auto p-4 border-t border-slate-200">
                                        <button
                                            onClick={handleFactoryReset}
                                            className={`w-full py-2 px-3 text-xs rounded border transition-colors flex items-center justify-center gap-2 ${confirmReset ? 'bg-red-600 text-white border-red-700' : 'text-red-500 hover:bg-red-50 border-transparent hover:border-red-100'}`}
                                        >
                                            {confirmReset ? (
                                                <>Wirklich zurücksetzen?</>
                                            ) : (
                                                <><RotateCcw className="w-3 h-3" /> App komplett Reset</>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                <div className="md:col-span-2 p-6 flex flex-col h-full overflow-y-auto">
                                    {editingId === 'API_CONFIG' ? (
                                        <div className="space-y-6">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">API Konfiguration</h2></div>
                                            <div className="bg-slate-50 p-4 rounded text-sm text-slate-600 border border-slate-200">
                                                <div className="flex items-center gap-2 mb-2 font-bold">
                                                    Aktiver Modus: {renderProviderBadge()}
                                                </div>
                                                <p className="text-xs text-slate-500 mb-1">
                                                    Die App erkennt automatisch anhand des Keys, welchen Anbieter Sie nutzen:
                                                </p>
                                                <ul className="list-disc list-inside text-xs space-y-1 ml-1">
                                                    <li><code>gsk_...</code> → <strong>Groq</strong> (Llama 3.3) - <em>Extrem schnell</em></li>
                                                    <li><code>sk-...</code> → <strong>OpenAI</strong> (GPT-3.5/4) - <em>Standard</em></li>
                                                    <li>(Leer) → <strong>Simulation</strong> (Offline)</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">API Key</label>
                                                <input
                                                    type="password"
                                                    value={editApiKey}
                                                    onChange={e => setEditApiKey(e.target.value)}
                                                    className="w-full border p-2 rounded focus:ring-2 ring-indigo-500 outline-none font-mono text-sm"
                                                    placeholder="gsk_... oder sk-..."
                                                />
                                            </div>
                                            <button onClick={() => { setApiKey(editApiKey); alert('Gespeichert! Provider wird automatisch erkannt.'); }} className="bg-indigo-600 text-white px-4 py-2 rounded self-start flex items-center gap-2 hover:bg-indigo-700 transition-colors"><Save className="w-4 h-4" /> Speichern</button>
                                        </div>
                                    ) : editingId === 'GENERIC_CONFIG' ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">Standard-Richtlinien anpassen</h2></div>
                                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded text-sm text-emerald-800">
                                                Diese Richtlinien werden verwendet, wenn im Workspace "Allgemein (Standard)" ausgewählt ist.
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">Default Policy Text</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-emerald-500 outline-none resize-none" />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-emerald-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-emerald-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> Speichern
                                                </button>
                                            </div>
                                        </div>
                                    ) : editingId ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4 flex justify-between items-center">
                                                <h2 className="text-lg font-bold">{editingId === 'NEW' ? 'Neuer Shop' : 'Shop bearbeiten'}</h2>
                                                {editingId !== 'NEW' && <button onClick={() => deleteCompany(editingId)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Name</label>
                                                <input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="w-full border p-2 rounded focus:ring-2 ring-blue-500 outline-none" placeholder="Shop Name" />
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">Richtlinien & Tonalität</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-blue-500 outline-none resize-none" placeholder="Regeln hier..." />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-blue-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> Speichern
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-300">
                                            <Settings className="w-16 h-16 mb-4 opacity-20" />
                                            <p>Wählen Sie links einen Shop oder die Konfiguration aus.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>