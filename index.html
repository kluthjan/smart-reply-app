<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSupply</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Error Overlay Style */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            z-index: 9999;
            overflow: auto;
            font-family: monospace;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-50">
    <div id="error-overlay"></div>
    <div id="root"></div>

    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            const div = document.getElementById('error-overlay');
            div.style.display = 'block';
            div.innerHTML = `<h3>Kritischer Fehler</h3><p>${msg}</p><pre>${url}:${line}:${col}</pre><pre>${error && error.stack}</pre>`;
        };
    </script>

    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

        const SELECTED_MODEL = "Llama-3.2-3B-Instruct-q4f16_1-MLC"; // ~2GB, modern, fast

        window.webLLM = {
            engine: null,
            isLoaded: false,

            async init() {
                if (this.engine) return;

                const initProgressCallback = (report) => {
                    window.dispatchEvent(new CustomEvent('webllm-progress', { detail: report }));
                };

                this.engine = await CreateMLCEngine(SELECTED_MODEL, {
                    initProgressCallback,
                    logLevel: "INFO"
                });
                this.isLoaded = true;
            },

            async generate(messages) {
                if (!this.engine) await this.init();

                const response = await this.engine.chat.completions.create({
                    messages,
                    temperature: 0.7,
                    max_tokens: 1024,
                });
                return response.choices[0].message.content;
            }
        };
    </script>

    <script type="text/babel" data-presets="env,react">
        // --- React Imports ---
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Icon Components (Lucide Mock) ---
        const IconBase = ({ children, className = "w-4 h-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Mail = p => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></IconBase>;
        const FileText = p => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconBase>;
        const Copy = p => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></IconBase>;
        const Sparkles = p => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></IconBase>;
        const Settings = p => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Check = p => <IconBase {...p}><polyline points="20 6 9 17 4 12" /></IconBase>;
        const Clipboard = p => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /></IconBase>;
        const ArrowRight = p => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></IconBase>;
        const Zap = p => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const LogOut = p => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>;
        const RefreshCw = p => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>;
        const Plus = p => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>;
        const Trash2 = p => <IconBase {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const Save = p => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Building2 = p => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" /><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" /><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" /><path d="M10 6h4" /><path d="M10 10h4" /><path d="M10 14h4" /><path d="M10 18h4" /></IconBase>;
        const RotateCcw = p => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>;
        const Key = p => <IconBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></IconBase>;
        const AlertTriangle = p => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const X = p => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>;
        const Cpu = p => <IconBase {...p}><rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M15 2v2" /><path d="M15 20v2" /><path d="M2 15h2" /><path d="M2 9h2" /><path d="M20 15h2" /><path d="M20 9h2" /><path d="M9 2v2" /><path d="M9 20v2" /></IconBase>;
        const Rocket = p => <IconBase {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" /><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" /><path d="M9 12H4s.55-3.03 2-4c1.62-1.1 4-1 4-1s-1.07 1.83-1 4z" /><path d="M12 15v5s3.03-.55 4-2c1.1-1.62 1-4 1-4s-1.83 1.07-4 1z" /></IconBase>;
        const FilePenLine = p => <IconBase {...p}><path d="m18 5-3-3H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2" /><path d="M8 18h1" /><path d="M18.4 2.6a2.17 2.17 0 0 1 3 3L16 11l-4 1 1-4Z" /></IconBase>;
        const WifiOff = p => <IconBase {...p}><line x1="2" y1="2" x2="22" y2="22" /><path d="M8.5 8.5A10 10 0 0 1 22 12" /><path d="M5 12a7 7 0 0 1 7-7 7 7 0 0 1 7 7" /><path d="M8.52 16.48A4 4 0 0 1 12 16c1.1 0 2.1.4 2.9 1.1" /><path d="M12 20h.01" /></IconBase>;
        const Globe = p => <IconBase {...p}><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconBase>;
        const LayoutGrid = p => <IconBase {...p}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></IconBase>;
        const AppWindow = p => <IconBase {...p}><rect x="2" y="4" width="20" height="16" rx="2" /><path d="M10 4v4" /><path d="M2 8h20" /><path d="M6 4v4" /></IconBase>;

        // --- Components ---
        const DraggableWindow = ({ id, title, rect, z, onUpdate, onFocus, children }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [isResizing, setIsResizing] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (isDragging) {
                        onUpdate(id, { ...rect, x: e.clientX - dragOffset.x, y: e.clientY - dragOffset.y });
                    }
                    if (isResizing) {
                        const newW = Math.max(320, e.clientX - rect.x);
                        const newH = Math.max(200, e.clientY - rect.y);
                        onUpdate(id, { ...rect, w: newW, h: newH });
                    }
                };
                const handleMouseUp = () => {
                    if (isDragging) setIsDragging(false);
                    if (isResizing) setIsResizing(false);
                };
                if (isDragging || isResizing) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    // Prevent text selection while dragging
                    document.body.style.userSelect = 'none';
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                    document.body.style.userSelect = '';
                };
            }, [isDragging, isResizing, dragOffset, onUpdate, id, rect]);

            return (
                <div
                    className="absolute bg-white rounded-xl shadow-2xl flex flex-col border border-slate-300 overflow-hidden"
                    style={{
                        left: rect.x, top: rect.y, width: rect.w, height: rect.h, zIndex: z,
                        transition: isDragging || isResizing ? 'none' : 'box-shadow 0.2s, border-color 0.2s',
                        boxShadow: z > 10 ? '0 25px 50px -12px rgba(0, 0, 0, 0.25)' : '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                    }}
                    onMouseDown={() => onFocus(id)}
                >
                    <div
                        className="bg-slate-100 border-b border-slate-200 p-2 cursor-move flex items-center justify-between select-none active:bg-slate-200 transition-colors"
                        onMouseDown={(e) => {
                            if (e.target.closest('.no-drag')) return; // Allow buttons in header
                            onFocus(id);
                            setIsDragging(true);
                            setDragOffset({ x: e.clientX - rect.x, y: e.clientY - rect.y });
                        }}
                    >
                        <span className="font-bold text-slate-600 text-xs px-2 flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-slate-400"></div> {title}
                        </span>
                    </div>

                    <div className="flex-1 overflow-hidden relative flex flex-col h-full bg-slate-50/50">
                        {children}
                    </div>

                    {/* Resize Handle */}
                    <div
                        className="absolute bottom-0 right-0 w-6 h-6 cursor-se-resize flex items-center justify-center text-slate-400 opacity-50 hover:opacity-100 z-20 hover:bg-slate-100 rounded-tl"
                        onMouseDown={(e) => {
                            onFocus(id);
                            e.stopPropagation();
                            setIsResizing(true);
                        }}
                    >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="transform rotate-90"><polyline points="21 15 21 21 15 21" /></svg>
                    </div>
                </div>
            );
        };


        const TRANSLATIONS = {
            de: {
                title: "SmartSupply",
                settings: "Einstellungen",
                workspace: "Workspace",
                incoming: "Eingehende Nachricht",
                paste: "Einfügen",
                copy: "Kopieren",
                copied: "Kopiert",
                reset: "Reset",
                confirmReset: "Wirklich löschen?",
                demo: "Demo Text laden",
                aiResponse: "KI-Antwort",
                fallback: "Fallback aktiv",
                generating: "generiert...",
                instrPlaceholder: 'Z.B. "Biete 5% Rabatt an" oder "Fasse dich kürzer"',
                manage: "Verwaltung",
                shops: "SHOPS",
                newShop: "Neuer Shop",
                editShop: "Shop bearbeiten",
                save: "Speichern",
                offlineBtn: "Offline-KI aktivieren",
                apiConfig: "KI & API Konfiguration",
                stdPolicy: "Standard-Richtlinien",
                policyLabel: "Richtlinien & Tonalität",
                name: "Name",
                apiKey: "API Key",
                appReset: "App komplett Reset",
                confirmAppReset: "Wirklich zurücksetzen?",
                genPolicyDefault: `ALLGEMEINE STANDARD-RICHTLINIE:\n- Tonalität: Professionell, höflich und lösungsorientiert.\n- Anrede: "Sie" (Standard), es sei denn der Kunde duzt offensichtlich.\n- Ziel: Beantworte die Anfrage direkt und präzise.\n- LÄNGE: Halte dich kurz. Maximal 2-4 Absätze.\n- Wichtig: Achte darauf keine widersprüchlichen Aussagen zu geben.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova GmbH', policyText: `RÜCKGABERICHTLINIEN:\n- Rückgabefrist beträgt 30 Tage nach Kaufdatum.\n- Artikel müssen originalverpackt sein.\n- Bei Defekten übernehmen wir die Versandkosten.\n- Rückerstattung erfolgt auf das ursprüngliche Zahlungsmittel innerhalb von 5 Werktagen.\n\nTONALITÄT:\n- Professionell, aber freundlich.\n- "Du" oder "Sie" je nach Kundenanrede (Standard: Sie).\n- Immer eine Ticket-ID angeben.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `UMTAUSCH:\n- Nur gegen Gutschein oder andere Größe.\n- Keine Barauszahlung.\n- Getragene Kleidung ist vom Umtausch ausgeschlossen.\n- Sale-Artikel sind finaler Verkauf (kein Umtausch).\n\nTONALITÄT:\n- Sehr persönlich, emotional, modebewusst.\n- Immer "Du".\n- Emojis sind erlaubt.` }
                ],
                simGreeting: "Guten Tag",
                simClosing: "Mit freundlichen Grüßen",
                simBody: "vielen Dank für Ihre Nachricht. Wir haben Ihr Anliegen erfasst.",
                simBodyDu: "danke für deine Nachricht. Wir kümmern uns darum!",
                simExtraSie: "Basierend auf Ihren Angaben werden wir den Vorgang prüfen und uns zeitnah mit einer Lösung bei Ihnen melden.",
                dummyContent: `Betreff: Problem mit meiner Bestellung #12345\n\nHallo Support-Team,\n\nich habe vor 20 Tagen bei euch einen Monitor gekauft (Bestellung #12345). Leider flackert der Bildschirm ab und zu. Ich habe die Originalverpackung noch.\nKann ich das Gerät zurückschicken und bekomme ich mein Geld zurück? Oder muss ich den Versand selbst zahlen?`,
                ourCompany: "Unser Unternehmen",
                customer: "Kunde",
                supportTeam: "Ihr Support-Team",
                errorUnknown: "Ein unbekannter Fehler ist aufgetreten.",
                errorCors: "Verbindung bei API blockiert (Netzwerk/CORS). Nutze Fallback.",
                errorApi: "API Fehler",
                settingsTitle: "Verwaltung",
                aiConfig: "KI & API Konfiguration",
                stdPolicies: "Standard-Richtlinien",
                selectShop: "Wählen Sie links einen Shop oder die Konfiguration aus.",
                layoutMode: "Ansicht",
                grid: "Raster (Standard)",
                custom: "Freie Fenster",
                resetLayout: "Fenster zurücksetzen",
                stackLayout: "Stapeln (Vertikal)",
                guestLogin: "Als Gast fortfahren",
                guestMode: "Gastmodus (Nicht gespeichert)",
                guestWarning: "Achtung: Im Gastmodus werden Änderungen nicht dauerhaft gespeichert.",
                inputPlaceholder: "Fügen Sie hier die E-Mail des Kunden ein...",
                policyPlaceholder: "Hier Richtlinien anpassen...",
                responsePlaceholder: "Die Antwort erscheint hier...",
                directEdit: "Direkt bearbeitbar",
                activeMode: "Aktiver Modus",
                providerInfo: "Die App erkennt automatisch anhand des Keys, welchen Anbieter Sie nutzen:",
                // Auth
                email: "E-Mail",
                username: "Benutzername",
                password: "Passwort",
                loginBtn: "Anmelden",
                registerBtn: "Registrieren",
                loading: "Lade...",
                logout: "Abmelden",
                importData: "Vorhandene Daten importieren?",
                recoveryTitle: "WICHTIG: Wiederherstellungscode",
                recoveryIntro: "Falls Sie Ihr Passwort vergessen, ist dies der einzige Weg, Ihren Account wiederherzustellen. Bitte speichern Sie diesen Code sicher ab.",
                recoverySave: "Ich habe den Code gespeichert & Weiter",
                forgotPassword: "Passwort vergessen?",
                recoveryModeTitle: "Passwort wiederherstellen",
                recoveryCodeLabel: "Wiederherstellungscode",
                newPasswordLabel: "Neues Passwort festlegen",
                resetBtn: "Passwort zurücksetzen",
                backToLogin: "Zurück zur Anmeldung",
                enterCodeAndPass: "Bitte Code und neues Passwort eingeben.",
                secureLocal: "Sichere, verschlüsselte lokale KI",
                noAccount: "Kein Konto? ",
                alreadyRegistered: "Bereits registriert? ",
                registerNow: "Jetzt registrieren"
            },
            en: {
                title: "SmartSupply",
                settings: "Settings",
                workspace: "Workspace",
                incoming: "Incoming Message",
                paste: "Paste",
                copy: "Copy",
                copied: "Copied",
                reset: "Reset",
                confirmReset: "Clear all?",
                demo: "Load Demo Text",
                aiResponse: "AI Response",
                fallback: "Fallback active",
                generating: "generating...",
                instrPlaceholder: 'E.g. "Offer 5% discount" or "Make it shorter"',
                manage: "Management",
                shops: "SHOPS",
                newShop: "New Shop",
                editShop: "Edit Shop",
                save: "Save",
                offlineBtn: "Enable Offline AI",
                apiConfig: "AI & API Configuration",
                stdPolicy: "Standard Policies",
                policyLabel: "Policies & Tonality",
                name: "Name",
                apiKey: "API Key",
                appReset: "Full App Reset",
                confirmAppReset: "Really reset?",
                genPolicyDefault: `GENERAL STANDARD POLICY:\n- Tone: Professional, polite, and solution-oriented.\n- Salutation: "Dear" (formal), unless the customer is visibly informal.\n- Goal: Answer the request directly and precisely.\n- LENGTH: Keep it short. Max 2-4 paragraphs.\n- Important: Avoid contradictory statements.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova Inc.', policyText: `RETURN POLICY:\n- Return period is 30 days from purchase date.\n- Items must be in original packaging.\n- We cover shipping costs for defects.\n- Refunds are processed to original payment method within 5 business days.\n\nTONALITY:\n- Professional but friendly.\n- Always include a Ticket ID.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `EXCHANGE:\n- Only for voucher or different size.\n- No cash refunds.\n- Worn items are excluded from exchange.\n- Sale items are final sale (no exchange).\n\nTONALITY:\n- Very personal, emotional, fashion-conscious.\n- Emojis are allowed.` }
                ],
                simGreeting: "Hello",
                simClosing: "Best regards",
                simBody: "thank you for your message. We have received your request.",
                simBodyDu: "thanks for your message. We'll take care of it!",
                simExtraSie: "Based on your details, we will review the process and get back to you with a solution shortly.",
                dummyContent: `Subject: Problem with my order #12345\n\nHello Support Team,\n\nI bought a monitor from you 20 days ago (Order #12345). Unfortunately, the screen flickers occasionally. I still have the original packaging.\nCan I return the device and get a refund? Or do I have to pay for shipping myself?`,
                ourCompany: "Our Company",
                customer: "Customer",
                supportTeam: "Your Support Team",
                errorUnknown: "An unknown error occurred.",
                errorCors: "API connection blocked (Network/CORS). Using Fallback.",
                errorApi: "API Error",
                settingsTitle: "Management",
                aiConfig: "AI & API Configuration",
                stdPolicies: "Standard Policies",
                selectShop: "Select a shop or configuration on the left.",
                layoutMode: "View",
                grid: "Grid (Default)",
                custom: "Free Windows",
                resetLayout: "Reset Windows",
                stackLayout: "Stack Vertically",
                guestLogin: "Continue as Guest",
                guestMode: "Guest Mode (Not Saved)",
                guestWarning: "Warning: Changes are not saved permanently in Guest Mode.",
                inputPlaceholder: "Paste the customer email here...",
                policyPlaceholder: "Adjust policies here...",
                responsePlaceholder: "The response text will appear here...",
                directEdit: "Directly editable",
                activeMode: "Active Mode",
                providerInfo: "The app automatically detects the provider based on your key:",
                // Auth
                email: "Email",
                username: "Username",
                password: "Password",
                loginBtn: "Login",
                registerBtn: "Register",
                loading: "Loading...",
                logout: "Logout",
                importData: "Import existing data?",
                recoveryTitle: "IMPORTANT: Recovery Code",
                recoveryIntro: "If you forget your password, this is the only way to recover your account. Please save this code securely.",
                recoverySave: "I have saved the code & Continue",
                forgotPassword: "Forgot password?",
                recoveryModeTitle: "Recover Password",
                recoveryCodeLabel: "Recovery Code",
                newPasswordLabel: "Set New Password",
                resetBtn: "Reset Password",
                backToLogin: "Back to Login",
                enterCodeAndPass: "Please enter code and new password.",
                secureLocal: "Secure, encrypted local AI",
                noAccount: "No account? ",
                alreadyRegistered: "Already registered? ",
                registerNow: "Register now"
            },
            it: {
                title: "SmartSupply",
                settings: "Impostazioni",
                workspace: "Workspace",
                incoming: "Messaggio in arrivo",
                paste: "Incolla",
                copy: "Copia",
                copied: "Copiato",
                reset: "Reset",
                confirmReset: "Cancellare tutto?",
                demo: "Carica testo demo",
                aiResponse: "Risposta IA",
                fallback: "Fallback attivo",
                generating: "genera...",
                instrPlaceholder: 'Es. "Offri 5% sconto" o "Falla più breve"',
                manage: "Gestione",
                shops: "NEGOZI",
                newShop: "Nuovo Negozio",
                editShop: "Modifica Negozio",
                save: "Salva",
                offlineBtn: "Attiva IA Offline",
                apiConfig: "Configurazione IA & API",
                stdPolicy: "Direttive Standard",
                policyLabel: "Direttive & Tonalità",
                name: "Nome",
                apiKey: "Chiave API",
                appReset: "Reset Completo App",
                confirmAppReset: "Resettare davvero?",
                genPolicyDefault: `DIRETTIVA STANDARD GENERALE:\n- Tono: Professionale, gentile e orientato alla soluzione.\n- Saluto: "Lei" (formale), a meno che il cliente non usi il "Tu".\n- Obiettivo: Rispondi alla richiesta in modo diretto e preciso.\n- LUNGHEZZA: Sii breve. Massimo 2-4 paragrafi.\n- Importante: Evita dichiarazioni contraddittorie.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova Srl', policyText: `POLITICA DI RESO:\n- Il periodo di reso è di 30 giorni dalla data di acquisto.\n- Gli articoli devono essere nella confezione originale.\n- Copriamo le spese di spedizione per i difetti.\n- I rimborsi avvengono sul metodo di pagamento originale entro 5 giorni lavorativi.\n\nTONALITÀ:\n- Professionale ma amichevole.\n- Includere sempre un ID Ticket.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `CAMBIO:\n- Solo per buono o taglia diversa.\n- Nessun rimborso in contanti.\n- I capi indossati sono esclusi dal cambio.\n- Gli articoli in saldo sono vendita finale (nessun cambio).\n\nTONALITÀ:\n- Molto personale, emotivo, attento alla moda.\n- Emojis consentiti.` }
                ],
                simGreeting: "Buongiorno",
                simClosing: "Cordiali saluti",
                simBody: "grazie per il tuo messaggio. Abbiamo ricevuto la tua richiesta.",
                simBodyDu: "grazie per il tuo messaggio. Ce ne occuperemo!",
                simExtraSie: "Sulla base dei tuoi dettagli, esamineremo la pratica e ti risponderemo con una soluzione a breve.",
                dummyContent: `Oggetto: Problema con il mio ordine #12345\n\nCiao Team di Supporto,\n\nHo comprato un monitor da voi 20 giorni fa (Ordine #12345). Purtroppo, lo schermo sfarfalla ogni tanto. Ho ancora l'imballaggio originale.\nPosso restituire il dispositivo e ottenere un rimborso? O devo pagare io la spedizione?`,
                ourCompany: "La Nostra Azienda",
                customer: "Cliente",
                supportTeam: "Il Tuo Team di Supporto",
                errorUnknown: "Si è verificato un errore sconosciuto.",
                errorCors: "Connessione API bloccata (Rete/CORS). Uso Fallback.",
                errorApi: "Errore API",
                settingsTitle: "Gestione",
                aiConfig: "Configurazione IA & API",
                stdPolicies: "Direttive Standard",
                selectShop: "Seleziona un negozio o la configurazione a sinistra.",
                layoutMode: "Vista",
                grid: "Griglia (Default)",
                custom: "Finestre Libere",
                resetLayout: "Resetta Finestre",
                stackLayout: "Impila Verticalmente",
                guestLogin: "Continua come Ospite",
                guestMode: "Modo Ospite (Non Salvato)",
                guestWarning: "Attenzione: Le modifiche non vengono salvate in modo permanente.",
                inputPlaceholder: "Incolla qui l'email del cliente...",
                policyPlaceholder: "Modifica le direttive qui...",
                responsePlaceholder: "La risposta apparirà qui...",
                directEdit: "Modificabile direttamente",
                activeMode: "Modalità Attiva",
                providerInfo: "L'app rileva automaticamente il provider in base alla chiave:",
                // Auth
                email: "E-mail",
                username: "Nome utente",
                password: "Password",
                loginBtn: "Accedi",
                registerBtn: "Registrati",
                loading: "Caricamento...",
                logout: "Disconnettersi",
                importData: "Importare dati esistenti?",
                recoveryTitle: "IMPORTANTE: Codice di Recupero",
                recoveryIntro: "Se dimentichi la password, questo è l'unico modo per recuperare l'account. Salva questo codice in un luogo sicuro.",
                recoverySave: "Ho salvato il codice & Continua",
                forgotPassword: "Password dimenticata?",
                recoveryModeTitle: "Recupera Password",
                recoveryCodeLabel: "Codice di Recupero",
                newPasswordLabel: "Imposta Nuova Password",
                resetBtn: "Reimposta Password",
                backToLogin: "Torna al Login",
                enterCodeAndPass: "Inserisci codice e nuova password.",
                secureLocal: "IA locale sicura e crittografata",
                noAccount: "Non hai un account? ",
                alreadyRegistered: "Già registrato? ",
                registerNow: "Registrati ora"
            },
            es: {
                title: "SmartSupply",
                settings: "Ajustes",
                workspace: "Espacio de trabajo",
                incoming: "Mensaje entrante",
                paste: "Pegar",
                copy: "Copiar",
                copied: "Copiado",
                reset: "Reset",
                confirmReset: "¿Borrar todo?",
                demo: "Cargar texto demo",
                aiResponse: "Respuesta IA",
                fallback: "Fallback activo",
                generating: "generando...",
                instrPlaceholder: 'Ej. "Ofrece 5% descuento" o "Más breve"',
                manage: "Gestión",
                shops: "TIENDAS",
                newShop: "Nueva Tienda",
                editShop: "Editar Tienda",
                save: "Guardar",
                offlineBtn: "Activar IA Offline",
                apiConfig: "Configuración IA y API",
                stdPolicy: "Políticas Estándar",
                policyLabel: "Políticas y Tonalidad",
                name: "Nombre",
                apiKey: "Clave API",
                appReset: "Reset Completo App",
                confirmAppReset: "¿Resetear realmente?",
                genPolicyDefault: `POLÍTICA ESTÁNDAR GENERAL:\n- Tono: Profesional, amable y orientado a la solución.\n- Saludo: "Usted" (formal), a menos que el cliente use "Tú".\n- Objetivo: Responde a la solicitud de forma directa y precisa.\n- LONGITUD: Breve. Máximo 2-4 párrafos.\n- Importante: Evita declaraciones contradictorias.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova S.L.', policyText: `POLÍTICA DE DEVOLUCIÓN:\n- El plazo de devolución es de 30 días desde la compra.\n- Los artículos deben estar en su embalaje original.\n- Cubrimos los gastos de envío por defectos.\n- Reembolsos al método de pago original en 5 días laborables.\n\nTONALIDAD:\n- Profesional pero amable.\n- Incluir siempre un ID de Ticket.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `CAMBIO:\n- Solo por vale o talla diferente.\n- No hay reembolsos en efectivo.\n- La ropa usada está excluida del cambio.\n- Artículos en rebajas son venta final (sin cambio).\n\nTONALIDUAL:\n- Muy personal, emocional, a la moda.\n- Se permiten emojis.` }
                ],
                simGreeting: "Hola",
                simClosing: "Saludos cordiales",
                simBody: "gracias por su mensaje. Hemos recibido su solicitud.",
                simBodyDu: "gracias por tu mensaje. ¡Nos encargaremos de ello!",
                simExtraSie: "Basado en tus detalles, revisaremos el proceso y te responderemos con una solución en breve.",
                dummyContent: `Asunto: Problema con mi pedido #12345\n\nHola Equipo de Soporte,\n\nCompré un monitor hace 20 días (Pedido #12345). Desafortunadamente, la pantalla parpadea ocasionalmente. Todavía tengo el embalaje original.\n¿Puedo devolver el dispositivo y obtener un reembolso? ¿O tengo que pagar yo el envío?`,
                ourCompany: "Nuestra Empresa",
                customer: "Cliente",
                supportTeam: "Tu Equipo de Soporte",
                errorUnknown: "Ha ocurrido un error desconocido.",
                errorCors: "Conexión API bloqueada (Red/CORS). Usando Fallback.",
                errorApi: "Error de API",
                settingsTitle: "Gestión",
                aiConfig: "Configuración IA y API",
                stdPolicies: "Políticas Estándar",
                selectShop: "Seleccione una tienda o la configuración a la izquierda.",
                layoutMode: "Vista",
                grid: "Cuadrícula",
                custom: "Ventanas Libres",
                resetLayout: "Reiniciar Ventanas",
                stackLayout: "Apilar Verticalmente",
                guestLogin: "Continuar como Invitado",
                guestMode: "Modo Invitado (No Guardado)",
                guestWarning: "Advertencia: Los cambios no se guardan permanentemente.",
                inputPlaceholder: "Pegue el correo del cliente aquí...",
                policyPlaceholder: "Ajustar políticas aquí...",
                responsePlaceholder: "La respuesta aparecerá aquí...",
                directEdit: "Editable directamente",
                activeMode: "Modo Activo",
                providerInfo: "La aplicación detecta automáticamente el proveedor según su clave:",
                // Auth
                email: "Correo electrónico",
                username: "Usuario",
                password: "Password",
                loginBtn: "Acceder",
                registerBtn: "Registrarse",
                loading: "Cargando...",
                logout: "Cerrar sesión",
                importData: "¿Importar datos existentes?",
                recoveryTitle: "IMPORTANTE: Código de Recuperación",
                recoveryIntro: "Si olvidas tu contraseña, esta es la única forma de recuperar tu cuenta. Guarda este código en un lugar seguro.",
                recoverySave: "He guardado el código & Continuar",
                forgotPassword: "¿Olvidaste tu contraseña?",
                recoveryModeTitle: "Recuperar Contraseña",
                recoveryCodeLabel: "Código de Recuperación",
                newPasswordLabel: "Establecer Nueva Contraseña",
                resetBtn: "Restablecer Contraseña",
                backToLogin: "Volver al inicio",
                enterCodeAndPass: "Introduce código y nueva contraseña.",
                secureLocal: "IA local segura y encriptada",
                noAccount: "¿No tienes cuenta? ",
                alreadyRegistered: "¿Ya registrado? ",
                registerNow: "Regístrate ahora"
            },
            fr: {
                title: "SmartSupply",
                settings: "Paramètres",
                workspace: "Espace de travail",
                incoming: "Message entrant",
                paste: "Coller",
                copy: "Copier",
                copied: "Copié",
                reset: "Réinitialiser",
                confirmReset: "Tout effacer ?",
                demo: "Charger texte démo",
                aiResponse: "Réponse IA",
                fallback: "Fallback actif",
                generating: "génère...",
                instrPlaceholder: 'Ex. "Offre 5% remise" ou "Plus court"',
                manage: "Gestion",
                shops: "BOUTIQUES",
                newShop: "Nouvelle Boutique",
                editShop: "Modifier Boutique",
                save: "Enregistrer",
                offlineBtn: "Activer IA Hors-ligne",
                apiConfig: "Config IA & API",
                stdPolicy: "Politiques Standard",
                policyLabel: "Politiques & Tonalité",
                name: "Nom",
                apiKey: "Clé API",
                appReset: "Reset Complet App",
                confirmAppReset: "Vraiment réinitialiser ?",
                genPolicyDefault: `POLITIQUE STANDARD GÉNÉRALE :\n- Ton : Professionnel, poli et orienté solution.\n- Salutation : "Vous" (formel), sauf si le client tutoie.\n- Objectif : Répondez à la demande directement et précisément.\n- LONGUEUR : Soyez bref. Max 2-4 paragraphes.\n- Important : Évitez les déclarations contradictoires.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova SAS', policyText: `POLITIQUE DE RETOUR :\n- Le délai de retour est de 30 jours après l'achat.\n- Les articles doivent être dans l'emballage d'origine.\n- Nous prenons en charge les frais de port pour les défauts.\n- Remboursements sur le moyen de paiement d'origine sous 5 jours ouvrés.\n\nTONALITÉ :\n- Professionnel mais amical.\n- Toujours inclure un ID de Ticket.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `ÉCHANGE :\n- Uniquement contre bon d'achat ou taille différente.\n- Pas de remboursement en espèces.\n- Les vêtements portés sont exclus de l'échange.\n- Les articles soldés sont en vente finale (pas d'échange).\n\nTONALITÉ :\n- Très personnel, émotionnel, mode.\n- Emojis autorisés.` }
                ],
                simGreeting: "Bonjour",
                simClosing: "Cordialement",
                simBody: "merci pour votre message. Nous avons bien reçu votre demande.",
                simBodyDu: "merci pour ton message. On s'en occupe !",
                simExtraSie: "Sur la base de vos informations, nous examinerons le dossier et reviendrons vers vous avec une solution rapidement.",
                dummyContent: `Objet : Problème avec ma commande #12345\n\nBonjour l'équipe support,\n\nJ'ai acheté un écran chez vous il y a 20 jours (Commande #12345). Malheureusement, l'écran scintille de temps en temps. J'ai encore l'emballage d'origine.\nPuis-je retourner l'appareil et obtenir un remboursement ? Ou dois-je payer les frais de port ?`,
                ourCompany: "Notre Entreprise",
                customer: "Client",
                supportTeam: "Votre Équipe Support",
                errorUnknown: "Une erreur inconnue est survenue.",
                errorCors: "Connexion API bloquée (Réseau/CORS). Utilisation du Fallback.",
                errorApi: "Erreur API",
                settingsTitle: "Gestion",
                aiConfig: "Configuration IA & API",
                stdPolicies: "Politiques Standard",
                selectShop: "Sélectionnez une boutique ou la configuration à gauche.",
                layoutMode: "Vue",
                grid: "Grille",
                custom: "Fenêtres Libres",
                resetLayout: "Réinitialiser Fenêtres",
                stackLayout: "Empiler Verticalement",
                guestLogin: "Continuer en Invité",
                guestMode: "Mode Invité (Non Enregistré)",
                guestWarning: "Attention : Les modifications ne sont pas enregistrées définitivement.",
                inputPlaceholder: "Collez l'e-mail du client ici...",
                policyPlaceholder: "Ajustez les politiques ici...",
                responsePlaceholder: "La réponse apparaîtra ici...",
                directEdit: "Modifiable directement",
                activeMode: "Mode Actif",
                providerInfo: "L'application détecte automatiquement le fournisseur via la clé :",
                // Auth
                email: "E-mail",
                username: "Nom d'utilisateur",
                password: "Mot de passe",
                loginBtn: "Connexion",
                registerBtn: "S'inscrire",
                loading: "Chargement...",
                logout: "Déconnexion",
                importData: "Importer les données existantes ?",
                recoveryTitle: "IMPORTANT : Code de Récupération",
                recoveryIntro: "Si vous oubliez votre mot de passe, c'est le seul moyen de récupérer votre compte. Veuillez sauvegarder ce code en lieu sûr.",
                recoverySave: "J'ai sauvegardé le code & Continuer",
                forgotPassword: "Mot de passe oublié ?",
                recoveryModeTitle: "Récupérer le mot de passe",
                recoveryCodeLabel: "Code de Récupération",
                newPasswordLabel: "Définir nouveau mot de passe",
                resetBtn: "Réinitialiser le mot de passe",
                backToLogin: "Retour connexion",
                enterCodeAndPass: "Entrez le code et le nouveau mot de passe.",
                secureLocal: "IA locale sécurisée et chiffrée",
                noAccount: "Pas de compte ? ",
                alreadyRegistered: "Déjà inscrit ? ",
                registerNow: "Inscrivez-vous"
            },
            nl: {
                title: "SmartSupply",
                settings: "Instellingen",
                workspace: "Werkruimte",
                incoming: "Inkomend bericht",
                paste: "Plakken",
                copy: "Kopiëren",
                copied: "Gekopieerd",
                reset: "Reset",
                confirmReset: "Alles wissen?",
                demo: "Laad demotekst",
                aiResponse: "AI Antwoord",
                fallback: "Fallback actief",
                generating: "genereert...",
                instrPlaceholder: 'Bijv. "Bied 5% korting" of "Maak het korter"',
                manage: "Beheer",
                shops: "WINKELS",
                newShop: "Nieuwe Winkel",
                editShop: "Winkel bewerken",
                save: "Opslaan",
                offlineBtn: "Offline AI activeren",
                apiConfig: "AI & API Configuratie",
                stdPolicy: "Standaardbeleid",
                policyLabel: "Beleid & Toon",
                name: "Naam",
                apiKey: "API Sleutel",
                appReset: "Volledige App Reset",
                confirmAppReset: "Echt resetten?",
                genPolicyDefault: `ALGEMENE STANDAARD BELEID:\n- Toon: Professioneel, beleefd en oplossingsgericht.\n- Aanhef: "U" (formeel), tenzij de klant duidelijk tutoyeert.\n- Doel: Beantwoord de vraag direct en precies.\n- LENGTE: Houd het kort. Maximaal 2-4 alinea's.\n- Belangrijk: Vermijd tegenstrijdige verklaringen.`,
                defaultCompanies: [
                    { id: 'c1', name: 'TechNova BV', policyText: `RETOURBELEID:\n- Retourtermijn is 30 dagen na aankoopdatum.\n- Artikelen moeten in originele verpakking zitten.\n- Bij defecten vergoeden wij de verzendkosten.\n- Terugbetaling via de oorspronkelijke betaalmethode binnen 5 werkdagen.\n\nTOON:\n- Professioneel maar vriendelijk.\n- Vermeld altijd een Ticket-ID.` },
                    { id: 'c2', name: 'Fashion Boutique', policyText: `RUILEN:\n- Alleen voor tegoedbon of andere maat.\n- Geen geld terug.\n- Gedragen kleding kan niet worden geruild.\n- Sale-artikelen zijn definitieve verkoop (niet ruilen).\n\nTOON:\n- Zeer persoonlijk, emotioneel, modebewust.\n- Emoji's toegestaan.` }
                ],
                simGreeting: "Hallo",
                simClosing: "Met vriendelijke groet",
                simBody: "bedankt voor uw bericht. We hebben uw aanvraag ontvangen.",
                simBodyDu: "bedankt voor je bericht. We gaan ermee aan de slag!",
                simExtraSie: "Op basis van uw gegevens zullen we de zaak bekijken en snel met een oplossing komen.",
                dummyContent: `Onderwerp: Probleem met mijn bestelling #12345\n\nHallo Support Team,\n\nIk heb 20 dagen geleden een monitor bij jullie gekocht (Bestelling #12345). Helaas knippert het scherm af en toe. Ik heb de originele verpakking nog.\nKan ik het apparaat retourneren en krijg ik mijn geld terug? Of moet ik de verzendkosten zelf betalen?`,
                ourCompany: "Ons Bedrijf",
                customer: "Klant",
                supportTeam: "Uw Support Team",
                errorUnknown: "Er is een onbekende fout opgetreden.",
                errorCors: "API-verbinding geblokkeerd (Netwerk/CORS). Fallback wordt gebruikt.",
                errorApi: "API Fout",
                settingsTitle: "Beheer",
                aiConfig: "AI & API Configuratie",
                stdPolicies: "Standaard Beleid",
                selectShop: "Selecteer links een winkel of de configuratie.",
                layoutMode: "Weergave",
                grid: "Raster",
                custom: "Vrije Vensters",
                resetLayout: "Vensters Resetten",
                stackLayout: "Stapelen (Verticaal)",
                guestLogin: "Doorgaan als Gast",
                guestMode: "Gastmodus (Niet Opgeslagen)",
                guestWarning: "Waarschuwing: Wijzigingen worden niet permanent opgeslagen.",
                inputPlaceholder: "Plak hier de e-mail van de klant...",
                policyPlaceholder: "Pas beleid hier aan...",
                responsePlaceholder: "Het antwoord verschijnt hier...",
                directEdit: "Direct bewerkbaar",
                activeMode: "Actieve Modus",
                providerInfo: "De app detecteert automatisch de provider op basis van uw sleutel:",
                // Auth
                email: "E-mail",
                username: "Gebruikersnaam",
                password: "Wachtwoord",
                loginBtn: "Inloggen",
                registerBtn: "Registreren",
                loading: "Laden...",
                logout: "Uitloggen",
                importData: "Bestaande gegevens importeren?",
                recoveryTitle: "BELANGRIJK: Herstelcode",
                recoveryIntro: "Als u uw wachtwoord vergeet, is dit de enige manier om uw account te herstellen. Bewaar deze code goed.",
                recoverySave: "Ik heb de code opgeslagen & Verder",
                forgotPassword: "Wachtwoord vergeten?",
                recoveryModeTitle: "Wachtwoord herstellen",
                recoveryCodeLabel: "Herstelcode",
                newPasswordLabel: "Nieuw wachtwoord instellen",
                resetBtn: "Wachtwoord resetten",
                backToLogin: "Terug naar inloggen",
                enterCodeAndPass: "Voer code en nieuw wachtwoord in.",
                secureLocal: "Veilige, versleutelde lokale AI",
                noAccount: "Geen account? ",
                alreadyRegistered: "Al geregistreerd? ",
                registerNow: "Nu registreren"
            }
        };

        const GENERIC_ID = 'general';

        // SECURITY: DEFAULT KEY REMOVED FOR HOSTING
        const DEFAULT_TEST_KEY = '';

        const DEFAULT_COMPANIES = [
            {
                id: 'c1',
                name: 'TechNova GmbH',
                policyText: `RÜCKGABERICHTLINIEN:
- Rückgabefrist beträgt 30 Tage nach Kaufdatum.
- Artikel müssen originalverpackt sein.
- Bei Defekten übernehmen wir die Versandkosten.
- Rückerstattung erfolgt auf das ursprüngliche Zahlungsmittel innerhalb von 5 Werktagen.

TONALITY:
- Professionell, aber freundlich.
- "Du" oder "Sie" je nach Kundenanrede (Standard: Sie).
- Immer eine Ticket-ID angeben.`
            },
            {
                id: 'c2',
                name: 'Fashion Boutique',
                policyText: `UMTAUSCH:
- Nur gegen Gutschein oder andere Größe.
- Keine Barauszahlung.
- Getragene Kleidung ist vom Umtausch ausgeschlossen.
- Sale-Artikel sind finaler Verkauf (kein Umtausch).

TONALITY:
- Sehr persönlich, emotional, modebewusst.
- Immer "Du".
- Emojis sind erlaubt.`
            }
        ];

        // --- Helper: Robust Copy ---
        const robustCopyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                        resolve();
                    } catch (error) {
                        textArea.remove();
                        reject(error);
                    }
                });
            }
        };

        // --- Account & Security Managers ---
        class CryptoManager {
            constructor() {
                this.algo = { name: 'AES-GCM', length: 256 };
            }

            // --- Key Management ---
            async generateRecoveryCode() {
                // Format: XXXX-XXXX-XXXX-XXXX
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // No I, O, 0, 1
                let code = "";
                const randomValues = window.crypto.getRandomValues(new Uint8Array(16));
                for (let i = 0; i < 16; i++) {
                    code += chars[randomValues[i] % chars.length];
                    if ((i + 1) % 4 === 0 && i !== 15) code += "-";
                }
                return code;
            }

            // Create a random Master Key (Data Encryption Key)
            async generateMasterKey() {
                return window.crypto.subtle.generateKey(
                    this.algo,
                    true,
                    ["encrypt", "decrypt"]
                );
            }

            // Derive a Key Encryption Key (KEK) from Password/Code
            async deriveKey(secret, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", enc.encode(secret), { name: "PBKDF2" }, false, ["deriveKey"]
                );

                return window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    this.algo,
                    false,
                    ["wrapKey", "unwrapKey", "encrypt", "decrypt"] // Added wrap/unwrap
                );
            }

            // --- V2 Encryption (Key Wrapping) ---
            async encrypt(data, password, recoveryCode = null) {
                // 1. Generate new Master Key
                const masterKey = await this.generateMasterKey();
                const enc = new TextEncoder();

                // 2. Encrypt Data with Master Key
                const ivData = window.crypto.getRandomValues(new Uint8Array(12));
                const encryptedData = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: ivData },
                    masterKey,
                    enc.encode(JSON.stringify(data))
                );

                // 3. Wrap Master Key with Password
                const saltPass = window.crypto.getRandomValues(new Uint8Array(16));
                const ivPass = window.crypto.getRandomValues(new Uint8Array(12));
                const keyPass = await this.deriveKey(password, saltPass);
                const wrappedKeyPass = await window.crypto.subtle.wrapKey(
                    "raw", masterKey, keyPass, { name: "AES-GCM", iv: ivPass }
                );

                // 4. Wrap Master Key with Recovery Code (if provided)
                let sealedRecovery = null;
                if (recoveryCode) {
                    const saltRec = window.crypto.getRandomValues(new Uint8Array(16));
                    const ivRec = window.crypto.getRandomValues(new Uint8Array(12));
                    const keyRec = await this.deriveKey(recoveryCode, saltRec);
                    const wrappedKeyRec = await window.crypto.subtle.wrapKey(
                        "raw", masterKey, keyRec, { name: "AES-GCM", iv: ivRec }
                    );

                    sealedRecovery = {
                        salt: btoa(String.fromCharCode(...saltRec)),
                        iv: btoa(String.fromCharCode(...ivRec)),
                        data: btoa(String.fromCharCode(...new Uint8Array(wrappedKeyRec)))
                    };
                }

                // Structure V2
                return {
                    version: 2,
                    encryptedData: {
                        iv: btoa(String.fromCharCode(...ivData)),
                        data: btoa(String.fromCharCode(...new Uint8Array(encryptedData)))
                    },
                    wrappedKeys: {
                        password: {
                            salt: btoa(String.fromCharCode(...saltPass)),
                            iv: btoa(String.fromCharCode(...ivPass)),
                            data: btoa(String.fromCharCode(...new Uint8Array(wrappedKeyPass)))
                        },
                        recovery: sealedRecovery
                    }
                };
            }

            async decrypt(vault, secret) {
                try {
                    // Check Version
                    if (!vault.version || vault.version === 1) {
                        return this.decryptV1(vault, secret);
                    }

                    // V2 Logic
                    // Try to unwrap Master Key using the secret (could be password OR recovery code)
                    // We try both slots because we don't know which one the user entered
                    let masterKey = null;

                    // Try Password Slot
                    try {
                        masterKey = await this.unwrapMasterKey(vault.wrappedKeys.password, secret);
                    } catch (e) { }

                    // Try Recovery Slot
                    if (!masterKey && vault.wrappedKeys.recovery) {
                        try {
                            masterKey = await this.unwrapMasterKey(vault.wrappedKeys.recovery, secret);
                        } catch (e) { }
                    }

                    if (!masterKey) throw new Error("Kein Zugriff möglich (Falsches Passwort/Code)");

                    // Decrypt actual data
                    const iv = Uint8Array.from(atob(vault.encryptedData.iv), c => c.charCodeAt(0));
                    const data = Uint8Array.from(atob(vault.encryptedData.data), c => c.charCodeAt(0));

                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv }, masterKey, data
                    );

                    const dec = new TextDecoder();
                    return JSON.parse(dec.decode(decrypted));

                } catch (e) {
                    console.error("Decryption failed:", e);
                    throw new Error("Zugriff verweigert (Passwort/Code falsch).");
                }
            }

            async unwrapMasterKey(wrappedObj, secret) {
                const salt = Uint8Array.from(atob(wrappedObj.salt), c => c.charCodeAt(0));
                const iv = Uint8Array.from(atob(wrappedObj.iv), c => c.charCodeAt(0));
                const data = Uint8Array.from(atob(wrappedObj.data), c => c.charCodeAt(0));

                const kek = await this.deriveKey(secret, salt);

                return window.crypto.subtle.unwrapKey(
                    "raw",
                    data,
                    kek,
                    { name: "AES-GCM", iv: iv },
                    this.algo,
                    true,
                    ["encrypt", "decrypt"]
                );
            }

            // Legacy V1 Support
            async decryptV1(encryptedObj, password) {
                const salt = Uint8Array.from(atob(encryptedObj.salt), c => c.charCodeAt(0));
                const iv = Uint8Array.from(atob(encryptedObj.iv), c => c.charCodeAt(0));
                const data = Uint8Array.from(atob(encryptedObj.data), c => c.charCodeAt(0));

                const key = await this.deriveKey(password, salt); // V1 key was "encrypt/decrypt" usage
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv }, key, data
                );
                const dec = new TextDecoder();
                return JSON.parse(dec.decode(decrypted));
            }
        }

        const cryptoManager = new CryptoManager();

        // --- Auth Component ---
        // --- Auth Component ---
        const AuthScreen = ({ onLogin, language, setLanguage }) => {
            const [mode, setMode] = useState('login'); // login, register, recovery, show_code
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [recoveryCode, setRecoveryCode] = useState('');
            const [generatedCode, setGeneratedCode] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const tAuth = TRANSLATIONS[language];

            const handleAuth = async () => {
                setError('');
                setIsLoading(true);
                await new Promise(r => setTimeout(r, 600));

                try {
                    const storageKey = `user_vault_${username}`;
                    const existingUser = localStorage.getItem(storageKey);

                    if (mode === 'login') {
                        if (!existingUser) throw new Error("USER_NOT_FOUND");
                        const vault = JSON.parse(existingUser);
                        const data = await cryptoManager.decrypt(vault, password);
                        onLogin(username, password, data);
                    } else if (mode === 'register') {
                        if (existingUser) throw new Error("EMAIL_REGISTERED");

                        // New: Generate Recovery Code
                        const code = await cryptoManager.generateRecoveryCode();

                        // Use localized defaults
                        let initialData = {
                            companies: tAuth.defaultCompanies,
                            apiKey: DEFAULT_TEST_KEY,
                            genericPolicy: tAuth.genPolicyDefault
                        };

                        const legacyComps = localStorage.getItem('smart_reply_companies');
                        if (legacyComps) {
                            initialData.companies = JSON.parse(legacyComps);
                            initialData.apiKey = localStorage.getItem('smart_reply_api_key') || '';
                            initialData.genericPolicy = localStorage.getItem('smart_reply_generic_policy') || tAuth.genPolicyDefault;
                        }

                        // Encrypt with Password AND Recovery Code
                        const encrypted = await cryptoManager.encrypt(initialData, password, code);
                        localStorage.setItem(storageKey, JSON.stringify(encrypted));

                        // Show Code to User
                        setGeneratedCode(code);
                        setMode('show_code');
                    } else if (mode === 'recovery') {
                        if (!existingUser) throw new Error("USER_NOT_FOUND");
                        if (!recoveryCode.trim() || !password.trim()) throw new Error("MISSING_INPUT");

                        // 1. Decrypt with Recovery Code
                        const vault = JSON.parse(existingUser);
                        const data = await cryptoManager.decrypt(vault, recoveryCode.trim());

                        // 2. Generate NEW Recovery Code (rotation)
                        const newCode = await cryptoManager.generateRecoveryCode();

                        // 3. Re-Encrypt with NEW Password and NEW Code
                        const encrypted = await cryptoManager.encrypt(data, password, newCode);
                        localStorage.setItem(storageKey, JSON.stringify(encrypted));

                        // 4. Show NEW Code
                        setGeneratedCode(newCode);
                        setMode('show_code');
                    }
                } catch (e) {
                    let msg = e.message;
                    if (msg === "USER_NOT_FOUND") msg = tAuth.userNotFound || "Benutzer nicht gefunden (User not found).";
                    else if (msg === "EMAIL_REGISTERED") msg = tAuth.emailRegistered || "E-Mail bereits registriert.";
                    else if (msg === "MISSING_INPUT") msg = tAuth.enterCodeAndPass || "Bitte Code und neues Passwort eingeben.";
                    else if (msg === "ACCESS_DENIED" || msg.includes("Zugriff verweigert")) msg = tAuth.accessDenied || "Zugriff verweigert (Passwort/Code falsch).";
                    // Fallback for CryptoManager legacy error
                    else if (msg.includes("Falsches Passwort")) msg = tAuth.accessDenied;

                    setError(msg);
                } finally {
                    setIsLoading(false);
                }
            };

            const finalizeLogin = () => {
                // Determine data (need to decrypt again or pass from state? Simplified: just Login)
                // Actually we already have the password in state, so we can just trigger login logic again
                // or easier: just decrypt again with password to get data object
                setIsLoading(true);
                const storageKey = `user_vault_${username}`;
                const vault = JSON.parse(localStorage.getItem(storageKey));
                cryptoManager.decrypt(vault, password).then(data => {
                    onLogin(username, password, data);
                });
            };

            if (mode === 'show_code') {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                        <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden p-8 text-center">
                            <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Key className="w-8 h-8 text-green-600" />
                            </div>
                            <h2 className="text-xl font-bold mb-2">{tAuth.recoveryTitle}</h2>
                            <p className="text-sm text-slate-600 mb-6">
                                {tAuth.recoveryIntro}
                            </p>

                            <div className="bg-slate-100 p-4 rounded-lg font-mono text-lg tracking-wider border border-slate-200 select-all mb-6 break-all">
                                {generatedCode}
                            </div>

                            <button onClick={finalizeLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">
                                {tAuth.recoverySave}
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl -mt-20 overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-8 text-center text-white">
                            <div className="bg-white/20 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                                <Zap className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-2xl font-bold">SmartSupply</h1>
                            <p className="text-blue-100 text-sm mt-2">{mode === 'recovery' ? tAuth.recoveryModeTitle : tAuth.secureLocal}</p>
                        </div>

                        <div className="p-8">
                            {error && (
                                <div className="mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm flex items-center gap-2">
                                    <AlertTriangle className="w-4 h-4" /> {error}
                                </div>
                            )}

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">{tAuth.email || "E-Mail"}</label>
                                    <input
                                        type="email"
                                        value={username}
                                        onChange={e => setUsername(e.target.value)}
                                        className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="name@example.com"
                                    />
                                </div>

                                {mode === 'recovery' ? (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">{tAuth.recoveryCodeLabel}</label>
                                            <input
                                                type="text"
                                                value={recoveryCode}
                                                onChange={e => setRecoveryCode(e.target.value)}
                                                className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono"
                                                placeholder="XXXX-XXXX-XXXX-XXXX"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">{tAuth.newPasswordLabel}</label>
                                            <input
                                                type="password"
                                                value={password}
                                                onChange={e => setPassword(e.target.value)}
                                                className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder={tAuth.newPasswordLabel}
                                            />
                                        </div>
                                    </>
                                ) : (
                                    <div>
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="block text-sm font-medium text-slate-700">{tAuth.password || "Passwort"}</label>
                                            {mode === 'login' && (
                                                <button onClick={() => setMode('recovery')} className="text-xs text-blue-600 hover:underline">
                                                    {tAuth.forgotPassword}
                                                </button>
                                            )}
                                        </div>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={e => setPassword(e.target.value)}
                                            className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            placeholder="••••••••"
                                            onKeyDown={e => e.key === 'Enter' && handleAuth()}
                                        />
                                    </div>
                                )}

                                <button onClick={handleAuth} disabled={isLoading} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                    {isLoading ? <span className="animate-spin text-xl">◌</span> : (mode === 'login' ? tAuth.loginBtn : (mode === 'register' ? tAuth.registerBtn : tAuth.recoverySubmit))}
                                </button>
                                {mode === 'login' && (
                                    <>
                                        <div className="relative my-6">
                                            <div className="absolute inset-0 flex items-center">
                                                <span className="w-full border-t border-slate-300"></span>
                                            </div>
                                            <div className="relative flex justify-center text-xs uppercase">
                                                <span className="bg-white px-2 text-slate-500">Oder</span>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => onLogin('Guest', null, null)}
                                            className="w-full bg-slate-100 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-200 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <span className="text-xl">🕵️</span> {tAuth.guestLogin}
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 text-center text-sm text-slate-500 border-t border-slate-100">
                            {mode === 'recovery' ? (
                                <button onClick={() => setMode('login')} className="text-blue-600 font-bold hover:underline">
                                    {tAuth.backToLogin}
                                </button>
                            ) : (
                                <>
                                    {mode === 'login' ? tAuth.noAccount : tAuth.alreadyRegistered}
                                    <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 font-bold hover:underline">
                                        {mode === 'login' ? tAuth.registerNow : tAuth.loginBtn}
                                    </button>
                                </>
                            )}
                        </div>

                        <div className="p-4 border-t border-slate-200 bg-white flex justify-center">
                            <select
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                className="text-sm bg-transparent border-none focus:ring-0 text-slate-400 cursor-pointer"
                            >
                                <option value="de">Deutsch</option>
                                <option value="en">English</option>
                                <option value="it">Italiano</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="nl">Nederlands</option>
                            </select>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        function App() {
            // --- Global Auth State ---
            const [currentUser, setCurrentUser] = useState(null); // { username, password (for encryption) }
            const [language, setLanguage] = useState(() => localStorage.getItem('smart_reply_language') || 'de');

            // --- Persistent State (loaded from encrypted vault or defaults) ---
            const [companies, setCompanies] = useState(DEFAULT_COMPANIES);
            const [selectedCompanyId, setSelectedCompanyId] = useState(GENERIC_ID);
            const [apiKey, setApiKey] = useState(DEFAULT_TEST_KEY);
            const [genericPolicy, setGenericPolicy] = useState('');

            // --- Effects ---
            const t = TRANSLATIONS[language];

            // Initialize default generic policy if empty
            useEffect(() => {
                if (!genericPolicy) setGenericPolicy(t.genPolicyDefault);
            }, [language]);

            // Save changes to ENCRYPTED storage whenever relevant state changes
            useEffect(() => {
                if (!currentUser) return;

                const saveData = async () => {
                    const dataToEncrypt = {
                        companies,
                        apiKey,
                        genericPolicy
                    };
                    try {
                        const encrypted = await cryptoManager.encrypt(dataToEncrypt, currentUser.password);
                        localStorage.setItem(`user_vault_${currentUser.username}`, JSON.stringify(encrypted));
                        console.log("Vault saved encrypted.");
                    } catch (e) {
                        console.error("Save failed", e);
                    }
                };

                // Debounce save to avoid thrashing crypto
                const timeoutId = setTimeout(saveData, 1000);
                return () => clearTimeout(timeoutId);

            }, [companies, apiKey, genericPolicy, currentUser]);

            // --- Handlers ---
            const handleLogin = (username, password, decryptedData) => {
                const data = decryptedData || {};
                setCompanies(data.companies || DEFAULT_COMPANIES);
                setApiKey(data.apiKey || '');
                setGenericPolicy(data.genericPolicy || t.genPolicyDefault);

                setCurrentUser({ username, password, isGuest: username === 'Guest' });
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setCompanies(DEFAULT_COMPANIES);
                setApiKey('');
            };

            // Moved AuthScreen check to main return

            // ... (Rest of App logic needs to remove the old localStorage calls)

            // --- Runtime State ---
            const [activeTab, setActiveTab] = useState('workspace');
            const [incomingMail, setIncomingMail] = useState('');
            const [policyContent, setPolicyContent] = useState('');

            const [generatedResponse, setGeneratedResponse] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [customInstruction, setCustomInstruction] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [usedFallback, setUsedFallback] = useState(false);

            const [copySuccess, setCopySuccess] = useState(false);
            const [inputCopySuccess, setInputCopySuccess] = useState(false);
            const [manualEditMode, setManualEditMode] = useState(false);
            const [confirmReset, setConfirmReset] = useState(false);
            const [pasteError, setPasteError] = useState(false);
            const [webLLMProgress, setWebLLMProgress] = useState('');

            useEffect(() => {
                const onProgress = (e) => setWebLLMProgress(e.detail.text);
                window.addEventListener('webllm-progress', onProgress);
                return () => window.removeEventListener('webllm-progress', onProgress);
            }, []);

            // --- Layout State ---
            const [layoutMode, setLayoutMode] = useState(localStorage.getItem('smart_reply_layout_mode') || 'grid');
            const [windows, setWindows] = useState(() => {
                const saved = localStorage.getItem('smart_reply_windows');
                return saved ? JSON.parse(saved) : {
                    incoming: { x: 20, y: 20, w: 400, h: 500, z: 10 },
                    policy: { x: 440, y: 20, w: 400, h: 500, z: 11 },
                    response: { x: 860, y: 20, w: 500, h: 600, z: 12 }
                };
            });

            // --- Settings UI State ---
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPolicy, setEditPolicy] = useState('');
            const [editApiKey, setEditApiKey] = useState('');

            // --- Helper: Detect Provider ---
            const getProvider = (key) => {
                if (key === 'webllm') return 'WEBLLM';
                if (key.startsWith('gsk_')) return 'GROQ';
                if (key.startsWith('sk-')) return 'OPENAI';
                return 'SIMULATION';
            };

            const activeProvider = getProvider(apiKey);

            // --- Effects ---
            useEffect(() => {
                if (!currentUser?.isGuest) localStorage.setItem('smart_reply_last_company', selectedCompanyId);
            }, [selectedCompanyId, currentUser]);

            useEffect(() => { setEditApiKey(apiKey); }, [apiKey]);

            // --- Persistence for Data ---
            useEffect(() => {
                if (!currentUser?.isGuest) localStorage.setItem('smart_reply_companies', JSON.stringify(companies));
            }, [companies, currentUser]);

            useEffect(() => {
                if (!currentUser?.isGuest) localStorage.setItem('smart_reply_generic_policy', genericPolicy);
            }, [genericPolicy, currentUser]);

            // --- Persistence for Layout ---
            useEffect(() => {
                if (!currentUser?.isGuest) localStorage.setItem('smart_reply_layout_mode', layoutMode);
            }, [layoutMode, currentUser]);

            useEffect(() => {
                if (!currentUser?.isGuest) localStorage.setItem('smart_reply_windows', JSON.stringify(windows));
            }, [windows, currentUser]);

            // --- Window Handlers ---
            const handleWindowUpdate = (id, newRect) => {
                setWindows(prev => ({ ...prev, [id]: { ...prev[id], ...newRect } }));
            };

            const handleWindowFocus = (id) => {
                // Find max Z
                const maxZ = Math.max(...Object.values(windows).map(w => w.z));
                if (windows[id].z === maxZ) return;
                setWindows(prev => ({ ...prev, [id]: { ...prev[id], z: maxZ + 1 } }));
            };

            const resetWindows = () => {
                setWindows({
                    incoming: { x: 20, y: 20, w: 400, h: 500, z: 10 },
                    policy: { x: 440, y: 20, w: 400, h: 500, z: 11 },
                    response: { x: 860, y: 20, w: 500, h: 600, z: 12 }
                });
            };

            const stackWindows = () => {
                setWindows({
                    incoming: { x: 40, y: 20, w: 600, h: 250, z: 10 },
                    policy: { x: 40, y: 300, w: 600, h: 250, z: 11 },
                    response: { x: 40, y: 580, w: 600, h: 300, z: 12 }
                });
            };

            // --- Smart Language Sync (Auto-Translate Defaults) ---
            useEffect(() => {
                localStorage.setItem('smart_reply_language', language);

                if (!TRANSLATIONS[language]) return;
                const tNew = TRANSLATIONS[language];
                const clean = (s) => s ? s.replace(/\s+/g, '').toLowerCase() : '';

                // 1. Sync Generic Policy
                const curGenParam = clean(genericPolicy);
                const isGermanGen = curGenParam.includes("allgemeinestandard-richtlinie") || curGenParam.includes("tonalität:professionell");

                // If it looks like German default OR matches any known default
                const allGenDefs = Object.values(TRANSLATIONS).map(t => clean(t.genPolicyDefault));
                if (isGermanGen || allGenDefs.includes(curGenParam)) {
                    if (clean(tNew.genPolicyDefault) !== curGenParam) {
                        setGenericPolicy(tNew.genPolicyDefault);
                        if (selectedCompanyId === GENERIC_ID) setPolicyContent(tNew.genPolicyDefault);
                    }
                }

                // 2. Sync Companies (TechNova & Fashion Boutique)
                const nextCompanies = companies.map(c => {
                    if (c.id === 'c1' || c.id === 'c2') {
                        const cPol = clean(c.policyText);
                        const cName = clean(c.name);

                        // Detect German variants specifically
                        const isGermanTN = cName.includes("technovagmbh") || cPol.includes("rückgabefristbeträgt30tage");
                        const isGermanFB = cName.includes("fashionboutique") && (cPol.includes("umtausch") || cPol.includes("sehrpersönlich"));

                        // Check against any known default
                        const allDefs = Object.values(TRANSLATIONS)
                            .flatMap(t => t.defaultCompanies ? t.defaultCompanies.find(dc => dc.id === c.id) : [])
                            .filter(Boolean);

                        const isAnyDefault = allDefs.some(dc => clean(dc.policyText) === cPol);

                        if (isGermanTN || isGermanFB || isAnyDefault) {
                            const newDef = tNew.defaultCompanies.find(dc => dc.id === c.id);
                            if (newDef) {
                                // Update if content differs
                                if (clean(newDef.policyText) !== cPol || c.name !== newDef.name) {
                                    return { ...c, name: newDef.name, policyText: newDef.policyText };
                                }
                            }
                        }
                    }
                    return c;
                });

                if (JSON.stringify(nextCompanies) !== JSON.stringify(companies)) {
                    setCompanies(nextCompanies);
                    if (selectedCompanyId !== GENERIC_ID) {
                        const active = nextCompanies.find(c => c.id === selectedCompanyId);
                        if (active) setPolicyContent(active.policyText);
                    }
                }
            }, [language, companies, genericPolicy]);

            useEffect(() => {
                if (selectedCompanyId === GENERIC_ID) {
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    setPolicyContent(company ? company.policyText : genericPolicy);
                }
            }, [selectedCompanyId, activeTab]);

            useEffect(() => {
                if (confirmReset) {
                    const timer = setTimeout(() => setConfirmReset(false), 3000);
                    return () => clearTimeout(timer);
                }
            }, [confirmReset]);

            // --- Handlers: Logic ---
            const handlePolicyChange = (newText) => {
                setPolicyContent(newText);
                if (selectedCompanyId === GENERIC_ID) {
                    setGenericPolicy(newText);
                } else {
                    setCompanies(prev => prev.map(c =>
                        c.id === selectedCompanyId ? { ...c, policyText: newText } : c
                    ));
                }
            };

            const generateResponse = async (instruction) => {
                setIsGenerating(true);
                setManualEditMode(false);
                setErrorMsg('');
                setUsedFallback(false);
                setGeneratedResponse('');

                const company = companies.find(c => c.id === selectedCompanyId);
                const companyName = company ? company.name : t.ourCompany;
                const isGeneric = selectedCompanyId === GENERIC_ID;
                const currentPolicyText = policyContent;

                const systemPrompt = `Du bist ein Kundensupport-Agent für "${companyName}".
RICHTLINIEN:
${currentPolicyText}
${isGeneric ? "WICHTIG: Fasse dich kurz (max. 2-4 Absätze). Gib allgemeine Informationen." : ""}

AUFGABE:
Antworte dem Kunden professionell, empathisch und lösungsorientiert.
Beachte die Richtlinien genau.
Antworte NUR mit dem E-Mail-Text, ohne Einleitung wie "Hier ist ein Entwurf".`;

                const userPrompt = `Kunden-Email:
"""
${incomingMail}
"""

${instruction ? 'Zusatz-Anweisung: ' + instruction : ''}`;

                try {
                    if (activeProvider === 'WEBLLM') {
                        await callWebLLM(userPrompt, systemPrompt);
                    } else if (activeProvider === 'GROQ') {
                        await callGroqAI(userPrompt, systemPrompt);
                    } else if (activeProvider === 'OPENAI') {
                        await callOpenAI(userPrompt, systemPrompt);
                    } else {
                        await runSimulation(companyName, instruction);
                    }
                } catch (err) {
                    console.error("API Call Failed:", err);
                    console.error("API Call Failed:", err);
                    let friendlyError = t.errorUnknown;
                    if (err.message && (err.message.includes("Failed to fetch") || err.name === 'TypeError')) {
                        // CORS or Network error
                        friendlyError = t.errorCors;
                    } else {
                        friendlyError = `${t.errorApi}: ${err.message || err}.`;
                    }

                    setErrorMsg(friendlyError);
                    setUsedFallback(true);
                    await runSimulation(companyName, instruction);
                } finally {
                    setIsGenerating(false);
                }
            };

            const callWebLLM = async (prompt, systemContext) => {
                if (!window.webLLM) throw new Error("WebLLM nicht geladen");
                const response = await window.webLLM.generate([
                    { role: "system", content: systemContext },
                    { role: "user", content: prompt }
                ]);
                setGeneratedResponse(response);
            };

            const callGroqAI = async (prompt, systemContext) => {
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        // mode: 'cors' is default, explicit helps debug
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                            temperature: 0.7,
                        })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error?.message || `Groq API Error (${response.status})`);
                    }
                    const data = await response.json();
                    setGeneratedResponse(data.choices[0]?.message?.content || "");
                } catch (e) {
                    throw e;
                }
            };

            const callOpenAI = async (prompt, systemContext) => {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "system", content: systemContext }, { role: "user", content: prompt }],
                        temperature: 0.7,
                    })
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
                const data = await response.json();
                setGeneratedResponse(data.choices[0]?.message?.content || "");
            };

            const runSimulation = async (companyName, instruction) => {
                await new Promise(r => setTimeout(r, 800));

                if (selectedCompanyId === GENERIC_ID) {
                    setGeneratedResponse(`${t.simGreeting} ${incomingMail.includes('Mustermann') ? 'Herr Mustermann' : t.customer},\n\n${t.simBody}\n\n${t.simClosing},\n${t.supportTeam}`);
                    return;
                }

                let isDu = policyContent.toLowerCase().includes('immer "du"'); // simple heuristic
                const hasName = incomingMail.includes('Mustermann');
                const customerName = hasName ? (isDu ? 'Max' : 'Herr Mustermann') : t.customer;

                let body = isDu
                    ? `${t.simBodyDu} ${instruction ? instruction : ''}`
                    : `${t.simBody} ${instruction ? instruction : ''}`;

                if (!instruction && !isDu) {
                    body += ` ${t.simExtraSie}`;
                }

                setGeneratedResponse(`${isDu ? t.simGreeting : t.simGreeting} ${customerName},

${body}

${isDu ? t.simClosing : t.simClosing},
${t.supportTeam}`);
            };

            // --- Handlers ---
            const handleCopy = () => {
                robustCopyToClipboard(generatedResponse)
                    .then(() => {
                        setCopySuccess(true);
                        setTimeout(() => setCopySuccess(false), 2000);
                    })
                    .catch(() => alert('Kopieren fehlgeschlagen'));
            };

            const handleCopyInput = () => {
                robustCopyToClipboard(incomingMail)
                    .then(() => {
                        setInputCopySuccess(true);
                        setTimeout(() => setInputCopySuccess(false), 2000);
                    });
            };

            const handlePasteInput = async () => {
                setPasteError(false);
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) setIncomingMail(text);
                } catch (err) {
                    setPasteError(true);
                    setTimeout(() => setPasteError(false), 4000);
                }
            };

            const handleReset = () => {
                if (!confirmReset) {
                    setConfirmReset(true);
                } else {
                    setIncomingMail('');
                    setGeneratedResponse('');
                    setCustomInstruction('');
                    setManualEditMode(false);
                    setErrorMsg('');
                    setUsedFallback(false);
                    setCopySuccess(false);
                    setInputCopySuccess(false);
                    setConfirmReset(false);
                }
            };

            const handleFactoryReset = () => {
                if (confirmReset) {
                    localStorage.clear();
                    window.location.reload();
                } else {
                    setConfirmReset(true);
                }
            };

            // --- Settings Handlers ---
            const startAdding = () => { setEditingId('NEW'); setEditName('Neuer Shop'); setEditPolicy(''); };
            const startEditing = (c) => { setEditingId(c.id); setEditName(c.name); setEditPolicy(c.policyText); };

            const openGenericSettings = () => {
                setEditingId('GENERIC_CONFIG');
                setEditPolicy(genericPolicy);
            };

            const saveCompany = () => {
                if (editingId === 'GENERIC_CONFIG') {
                    setGenericPolicy(editPolicy);
                    return;
                }

                if (!editName.trim()) return;
                const newCo = { id: editingId === 'NEW' ? Date.now().toString() : editingId, name: editName, policyText: editPolicy };
                if (editingId === 'NEW') {
                    setCompanies([...companies, newCo]);
                    setEditingId(newCo.id); setSelectedCompanyId(newCo.id);
                } else {
                    setCompanies(companies.map(c => c.id === editingId ? newCo : c));
                }
            };

            const deleteCompany = (id) => {
                setCompanies(companies.filter(c => c.id !== id));
                if (selectedCompanyId === id) setSelectedCompanyId(GENERIC_ID);
                setEditingId(null);
            };

            const openApiSettings = () => {
                setEditingId('API_CONFIG');
                setEditApiKey(apiKey);
            };

            const openCurrentPolicySettings = () => {
                setActiveTab('settings');
                if (selectedCompanyId === GENERIC_ID) {
                    openGenericSettings();
                } else {
                    const company = companies.find(c => c.id === selectedCompanyId);
                    if (company) startEditing(company);
                }
            };

            const renderProviderBadge = () => {
                switch (activeProvider) {
                    case 'GROQ': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 text-[10px] font-bold border border-orange-200"><Rocket className="w-3 h-3" /><span>Groq</span></div>);
                    case 'OPENAI': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px] font-bold border border-green-200"><Zap className="w-3 h-3" /><span>OpenAI</span></div>);
                    case 'WEBLLM': return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-[10px] font-bold border border-purple-200"><Cpu className="w-3 h-3" /><span>WebLLM (Lokal)</span></div>);
                    default: return (<div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[10px] font-bold border border-slate-200"><Cpu className="w-3 h-3" /><span>Simulation</span></div>);
                }
            };

            const DUMMY_CLIPBOARD_CONTENT = `Betreff: Problem mit meiner Bestellung #12345
            
Hallo Support-Team,

ich habe vor 20 Tagen bei euch einen Monitor gekauft (Bestellung #12345). Leider flackert der Bildschirm ab und zu. Ich habe die Originalverpackung noch.
Kann ich das Gerät zurückschicken und bekomme ich mein Geld zurück? Oder muss ich den Versand selbst zahlen?

Viele Grüße,
Max Mustermann`;

            const loadDemoText = () => setIncomingMail(DUMMY_CLIPBOARD_CONTENT);

            // --- Render Helpers ---
            const renderIncoming = (isCustom) => (
                <section className={`${isCustom ? 'flex flex-col h-full' : 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[500px] relative transition-all focus-within:ring-2 ring-blue-100'}`}>
                    {!isCustom && (
                        <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center min-h-[50px]">
                            <div className="flex items-center gap-2 text-slate-700 font-medium">
                                <Mail className="w-4 h-4 text-blue-500" />
                                <h3>{t.incoming}</h3>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={handlePasteInput} className="text-slate-500 hover:text-blue-600 hover:bg-slate-100 p-2 rounded-md transition-colors flex items-center gap-2 text-xs font-medium" title={t.paste}>
                                    <Clipboard className="w-4 h-4" /> <span className="hidden xl:inline">{t.paste}</span>
                                </button>
                                {incomingMail && (
                                    <button
                                        onClick={handleCopyInput}
                                        className={`p-2 rounded-md transition-all flex items-center gap-2 text-xs font-medium ${inputCopySuccess ? 'bg-green-100 text-green-700' : 'text-slate-500 hover:text-blue-600 hover:bg-slate-100'}`}
                                        title="Text kopieren"
                                    >
                                        {inputCopySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                    </button>
                                )}
                                <div className="h-4 w-px bg-slate-200 mx-1"></div>
                                <button onClick={handleReset} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md transition-all text-xs font-medium ${confirmReset ? 'bg-red-100 text-red-700 w-auto' : 'text-slate-500 hover:text-red-600 hover:bg-red-50'}`} title={t.reset}>
                                    {confirmReset ? <><AlertTriangle className="w-3.5 h-3.5" /> {t.confirmReset}</> : <><RotateCcw className="w-3.5 h-3.5" /> <span className="hidden xl:inline">{t.reset}</span></>}
                                </button>
                            </div>
                        </div>
                    )}
                    {isCustom && <div className="absolute top-2 right-2 flex gap-1 z-10">
                        <button onClick={loadDemoText} className="text-xs bg-slate-100 hover:bg-blue-50 text-slate-500 hover:text-blue-600 px-2 py-1 rounded border border-slate-200">Demo</button>
                        <button onClick={handleReset} className="text-xs bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-600 px-2 py-1 rounded border border-slate-200"><RotateCcw className="w-3 h-3" /></button>
                    </div>}
                    <div className="relative flex-1 bg-white overflow-hidden flex flex-col">
                        <textarea
                            className="w-full h-full p-4 resize-none focus:outline-none text-slate-700 leading-relaxed text-base flex-1"
                            placeholder={t.inputPlaceholder}
                            value={incomingMail}
                            onChange={(e) => setIncomingMail(e.target.value)}
                        />
                        {!isCustom && !incomingMail && (
                            <div className="absolute bottom-4 right-4">
                                <button onClick={loadDemoText} className="text-xs text-slate-400 hover:text-blue-500 bg-slate-50 hover:bg-blue-50 px-3 py-1 rounded-full border border-slate-200 transition-colors">
                                    Demo Text laden
                                </button>
                            </div>
                        )}
                        {pasteError && (
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-100 text-red-700 px-4 py-2 rounded-full shadow-lg text-sm font-medium animate-in fade-in slide-in-from-top-4 flex items-center gap-2">
                                <AlertTriangle className="w-4 h-4" /> {t.pasteError}
                            </div>
                        )}
                    </div>
                </section>
            );

            const renderPolicy = (isCustom) => (
                <section className={`${isCustom ? 'flex flex-col h-full' : 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full relative'}`}>
                    {!isCustom && (
                        <div className={`px-4 py-3 border-b flex justify-between items-center ${selectedCompanyId === GENERIC_ID ? 'bg-emerald-50 border-emerald-100' : 'bg-slate-50 border-slate-200'}`}>
                            <div className={`flex items-center gap-2 font-medium ${selectedCompanyId === GENERIC_ID ? 'text-emerald-800' : 'text-slate-700'}`}>
                                <FileText className="w-4 h-4" />
                                <h3>{selectedCompanyId === GENERIC_ID ? t.stdPolicy : companies.find(c => c.id === selectedCompanyId)?.name}</h3>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={openCurrentPolicySettings} className="p-1.5 hover:bg-black/5 rounded text-slate-400 hover:text-slate-600 transition-colors">
                                    {selectedCompanyId === GENERIC_ID ? <span className="text-[10px] uppercase font-bold tracking-wider opacity-70 flex items-center gap-1">{t.editDirectly} <FilePenLine className="w-3 h-3" /></span> : <Settings className="w-3 h-3" />}
                                </button>
                            </div>
                        </div>
                    )}
                    <div className={`flex-1 relative ${selectedCompanyId === GENERIC_ID ? 'bg-emerald-50/30' : 'bg-slate-50'}`}>
                        <textarea
                            className={`w-full h-full p-4 resize-none focus:outline-none leading-relaxed text-sm font-mono ${selectedCompanyId === GENERIC_ID ? 'text-emerald-800 bg-transparent' : 'text-slate-600 bg-transparent'}`}
                            value={policyContent}
                            onChange={(e) => handlePolicyChange(e.target.value)}
                            spellCheck={false}
                            placeholder={t.policyPlaceholder}
                        />
                    </div>
                </section>
            );

            const renderResponse = (isCustom) => (
                <section className={`${isCustom ? 'flex flex-col h-full' : 'bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden flex flex-col h-full relative'}`}>
                    {!isCustom && (
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                            <div className="flex items-center gap-2 text-blue-900 font-bold">
                                <Sparkles className="w-4 h-4 text-blue-600" />
                                <h3>{t.aiResponse}</h3>
                            </div>
                            <div className="flex items-center gap-2">
                                {usedFallback && (
                                    <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                        <Cpu className="w-3 h-3" /> {t.fallback}
                                    </span>
                                )}
                                {renderProviderBadge()}
                            </div>
                        </div>
                    )}
                    <div className="flex-1 relative bg-white flex flex-col min-h-0">
                        {isGenerating && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/95 z-20 backdrop-blur-sm">
                                <div className="w-10 h-10 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                <p className="text-slate-600 text-sm font-medium animate-pulse">
                                    {activeProvider === 'WEBLLM' ? (webLLMProgress || t.loading) : t.loading}
                                </p>
                            </div>
                        )}
                        <textarea
                            className={`flex-1 w-full p-6 resize-none focus:outline-none text-slate-700 leading-relaxed text-base transition-colors ${manualEditMode ? 'bg-white' : 'bg-slate-50/30'}`}
                            placeholder={t.responsePlaceholder}
                            value={generatedResponse}
                            onChange={(e) => { setGeneratedResponse(e.target.value); setManualEditMode(true); }}
                        />
                        <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 shrank-0">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    placeholder={t.instrPlaceholder}
                                    className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
                                    value={customInstruction}
                                    onChange={(e) => setCustomInstruction(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && generateResponse(customInstruction)}
                                />
                                <button
                                    onClick={() => generateResponse(customInstruction)}
                                    disabled={!incomingMail || isGenerating}
                                    className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 p-2 rounded-lg disabled:opacity-50 transition-colors shadow-sm"
                                >
                                    <ArrowRight className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                        {/* Action Buttons */}
                        <div className="p-4 bg-white border-t border-slate-100 flex gap-4 shrank-0">
                            <button onClick={() => generateResponse()} disabled={!incomingMail} className="px-4 py-3 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-300 transition-colors shadow-sm">
                                <RefreshCw className="w-4 h-4" />
                            </button>
                            {generatedResponse && (
                                <button onClick={handleCopy} className={`flex-1 flex items-center justify-center gap-2 rounded-lg font-bold transition-all shadow-md ${copySuccess ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    {copySuccess ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                    {copySuccess ? t.copied : t.copy}
                                </button>
                            )}
                        </div>
                    </div>
                </section>
            );

            if (!currentUser) {
                return <AuthScreen onLogin={handleLogin} language={language} setLanguage={setLanguage} />;
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('workspace')}>
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg text-white">
                                <Zap className="w-5 h-5" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    SmartSupply
                                </h1>
                                <div className="mt-1">
                                    {renderProviderBadge()}
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            {/* Layout Toggle */}
                            {activeTab === 'workspace' && (
                                <div className="bg-slate-100 rounded-lg p-1 flex gap-1 border border-slate-200">
                                    <button
                                        onClick={() => setLayoutMode('grid')}
                                        className={`p-1.5 rounded-md transition-all ${layoutMode === 'grid' ? 'bg-white shadow text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        title={t.grid}
                                    >
                                        <LayoutGrid className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={() => setLayoutMode('custom')}
                                        className={`p-1.5 rounded-md transition-all ${layoutMode === 'custom' ? 'bg-white shadow text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        title={t.custom}
                                    >
                                        <AppWindow className="w-4 h-4" />
                                    </button>
                                </div>
                            )}

                            {activeTab === 'workspace' && (
                                <div className="relative hidden md:block">
                                    <select
                                        value={selectedCompanyId}
                                        onChange={(e) => setSelectedCompanyId(e.target.value)}
                                        className="appearance-none pl-9 bg-slate-100 border-none rounded-md pr-8 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer w-48 truncate"
                                    >
                                        <option value={GENERIC_ID}>{t.stdPolicy}</option>
                                        <optgroup label={t.shops}>
                                            {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </optgroup>
                                    </select>
                                    <Building2 className="w-4 h-4 text-slate-500 absolute left-3 top-2.5 pointer-events-none" />
                                </div>
                            )}

                            <div className="relative">
                                <select
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    className="appearance-none pl-9 bg-slate-100 border-none rounded-md pr-8 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer w-32"
                                >
                                    <option value="de">Deutsch 🇩🇪</option>
                                    <option value="en">English 🇺🇸</option>
                                    <option value="it">Italiano 🇮🇹</option>
                                    <option value="es">Español 🇪🇸</option>
                                    <option value="fr">Français 🇫🇷</option>
                                    <option value="nl">Nederlands 🇳🇱</option>
                                </select>
                                <Globe className="w-4 h-4 text-slate-500 absolute left-3 top-2.5 pointer-events-none" />
                            </div>

                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${activeTab === 'settings' ? 'bg-blue-50 text-blue-700' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                <Settings className="w-4 h-4" />
                                <span className="hidden sm:inline">{t.settings}</span>
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 w-full max-w-[1920px] mx-auto p-4 overflow-hidden relative">
                        {errorMsg && (
                            <div className="mb-6 p-4 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl flex items-center gap-3 shadow-sm animate-in fade-in slide-in-from-top-2">
                                <div className="p-2 bg-amber-100 rounded-full"><WifiOff className="w-4 h-4" /></div>
                                <div className="flex-1">
                                    <p className="font-semibold text-sm">Hinweis</p>
                                    <p className="text-xs opacity-90">{errorMsg}</p>
                                </div>
                                <button onClick={() => setErrorMsg('')} className="ml-auto text-amber-400 hover:text-amber-700"><X className="w-4 h-4" /></button>
                            </div>
                        )}

                        {activeTab === 'workspace' && layoutMode === 'grid' && (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                                <div className="lg:col-span-3 h-full overflow-hidden">
                                    {renderIncoming(false)}
                                </div>
                                <div className="lg:col-span-4 h-full overflow-hidden">
                                    {renderPolicy(false)}
                                </div>
                                <div className="lg:col-span-5 h-full overflow-hidden">
                                    {renderResponse(false)}
                                </div>
                            </div>
                        )}

                        {activeTab === 'workspace' && layoutMode === 'custom' && (
                            <div className="relative w-full min-h-[85vh] h-full bg-slate-200/50 rounded-xl overflow-hidden shadow-inner border border-slate-300">
                                <div className="absolute top-4 left-4 z-40 bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs text-slate-500 shadow border border-slate-200 pointer-events-none">
                                    {t.custom} Mode
                                </div>
                                <div className="absolute bottom-4 right-4 z-40 flex gap-2">
                                    <button onClick={stackWindows} className="bg-white hover:bg-blue-50 text-slate-500 hover:text-blue-600 px-3 py-1 rounded shadow border border-slate-200 text-xs flex items-center gap-1">
                                        <ArrowRight className="w-3 h-3 rotate-90" /> {t.stackLayout}
                                    </button>
                                    <button onClick={resetWindows} className="bg-white hover:bg-red-50 text-slate-500 hover:text-red-500 px-3 py-1 rounded shadow border border-slate-200 text-xs">
                                        {t.resetLayout}
                                    </button>
                                </div>

                                <DraggableWindow id="incoming" title={t.incoming} rect={windows.incoming} z={windows.incoming.z} onUpdate={handleWindowUpdate} onFocus={handleWindowFocus}>
                                    {renderIncoming(true)}
                                </DraggableWindow>

                                <DraggableWindow id="policy" title={t.stdPolicy} rect={windows.policy} z={windows.policy.z} onUpdate={handleWindowUpdate} onFocus={handleWindowFocus}>
                                    {renderPolicy(true)}
                                </DraggableWindow>

                                <DraggableWindow id="response" title={t.aiResponse} rect={windows.response} z={windows.response.z} onUpdate={handleWindowUpdate} onFocus={handleWindowFocus}>
                                    {renderResponse(true)}
                                </DraggableWindow>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="bg-slate-50 border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-200 flex flex-col gap-4 bg-white">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Settings className="w-4 h-4" /> {t.settingsTitle}
                                        </h2>

                                        <button
                                            onClick={openApiSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'API_CONFIG' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <Key className="w-4 h-4" />
                                            {t.aiConfig}
                                        </button>

                                        <button
                                            onClick={openGenericSettings}
                                            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${editingId === 'GENERIC_CONFIG' ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <FileText className="w-4 h-4" />
                                            {t.stdPolicies}
                                        </button>
                                    </div>

                                    <div className="p-2 bg-slate-50">
                                        <div className="flex justify-between items-center px-2 py-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t.shops}</span>
                                            <button onClick={startAdding} className="bg-white border border-slate-200 p-1 rounded hover:bg-blue-50 hover:border-blue-200 text-blue-600"><Plus className="w-3 h-3" /></button>
                                        </div>
                                        <div className="space-y-1 overflow-y-auto max-h-[400px]">
                                            {companies.map(c => (
                                                <button
                                                    key={c.id}
                                                    onClick={() => startEditing(c)}
                                                    className={`w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center gap-2 ${editingId === c.id ? 'bg-white shadow-sm text-blue-700 font-medium' : 'text-slate-600 hover:bg-slate-200'}`}
                                                >
                                                    <Building2 className="w-3 h-3 opacity-50" />
                                                    <span className="truncate">{c.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-auto p-4 border-t border-slate-200 flex flex-col gap-2">
                                        <div className="text-xs text-slate-400 px-1 truncate flex justify-between items-center">
                                            <span>User: <span className="font-medium text-slate-600">{currentUser?.isGuest ? t.guestMode : currentUser?.username}</span></span>
                                        </div>
                                        {currentUser?.isGuest && (
                                            <div className="text-[10px] text-amber-600 bg-amber-50 p-2 rounded border border-amber-100 mb-2">
                                                {t.guestWarning}
                                            </div>
                                        )}
                                        <button
                                            onClick={handleLogout}
                                            className="w-full py-2 px-3 text-xs rounded border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <LogOut className="w-3 h-3" /> {t.logout}
                                        </button>
                                        <button
                                            onClick={handleFactoryReset}
                                            className={`w-full py-2 px-3 text-xs rounded border transition-colors flex items-center justify-center gap-2 ${confirmReset ? 'bg-red-600 text-white border-red-700' : 'text-red-500 hover:bg-red-50 border-transparent hover:border-red-100'}`}
                                        >
                                            {confirmReset ? (
                                                <>{t.confirmAppReset}</>
                                            ) : (
                                                <><RotateCcw className="w-3 h-3" /> {t.appReset}</>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                <div className="md:col-span-2 p-6 flex flex-col h-full overflow-y-auto">
                                    {editingId === 'API_CONFIG' ? (
                                        <div className="space-y-6">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">{t.aiConfig}</h2></div>
                                            <div className="bg-slate-50 p-4 rounded text-sm text-slate-600 border border-slate-200">
                                                <div className="flex items-center gap-2 mb-2 font-bold">
                                                    {t.activeMode}: {renderProviderBadge()}
                                                </div>
                                                <p className="text-xs text-slate-500 mb-1">
                                                    {t.providerInfo}
                                                </p>
                                                <ul className="list-disc list-inside text-xs space-y-1 ml-1">
                                                    <li><code>gsk_...</code> → <strong>Groq</strong> (Llama 3.3) - <em>Extrem schnell</em></li>
                                                    <li><code>webllm</code> → <strong>WebLLM</strong> (Lokal im Browser)</li>
                                                    <li><code>sk-...</code> → <strong>OpenAI</strong> (GPT-3.5/4) - <em>Standard</em></li>
                                                    <li>(Leer) → <strong>Simulation</strong> (Offline)</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">{t.apiKey}</label>
                                                <input
                                                    type="password"
                                                    value={editApiKey}
                                                    onChange={e => setEditApiKey(e.target.value)}
                                                    className="w-full border p-2 rounded focus:ring-2 ring-indigo-500 outline-none font-mono text-sm"
                                                    placeholder="gsk_... oder sk-..."
                                                />
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => { setApiKey(editApiKey); alert(t.save + '!'); }} className="bg-indigo-600 text-white px-4 py-2 rounded self-start flex items-center gap-2 hover:bg-indigo-700 transition-colors"><Save className="w-4 h-4" /> {t.save}</button>
                                                <button onClick={() => { setApiKey('webllm'); setEditApiKey('webllm'); }} className="bg-purple-600 text-white px-4 py-2 rounded self-start flex items-center gap-2 hover:bg-purple-700 transition-colors"><Cpu className="w-4 h-4" /> Offline-KI aktivieren</button>
                                            </div>
                                        </div>
                                    ) : editingId === 'GENERIC_CONFIG' ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4"><h2 className="text-lg font-bold">{t.stdPolicies}</h2></div>
                                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded text-sm text-emerald-800">
                                                {t.genPolicyDefault.split('\n')[0]}
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">{t.stdPolicy}</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-emerald-500 outline-none resize-y min-h-[300px]" />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-emerald-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-emerald-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> {t.save}
                                                </button>
                                            </div>
                                        </div>
                                    ) : editingId ? (
                                        <div className="space-y-6 flex flex-col h-full">
                                            <div className="border-b pb-4 flex justify-between items-center">
                                                <h2 className="text-lg font-bold">{editingId === 'NEW' ? t.newShop : t.editShop}</h2>
                                                {editingId !== 'NEW' && <button onClick={() => deleteCompany(editingId)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">{t.name}</label>
                                                <input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="w-full border p-2 rounded focus:ring-2 ring-blue-500 outline-none" placeholder="Shop Name" />
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <label className="block text-sm font-medium mb-1">{t.policyLabel}</label>
                                                <textarea value={editPolicy} onChange={e => setEditPolicy(e.target.value)} className="flex-1 w-full border p-3 rounded font-mono text-sm focus:ring-2 ring-blue-500 outline-none resize-y min-h-[300px]" placeholder="Regeln hier..." />
                                            </div>
                                            <div className="pt-4 flex justify-end">
                                                <button onClick={saveCompany} className="bg-blue-600 text-white px-6 py-2 rounded font-medium shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                    <Save className="w-4 h-4" /> {t.save}
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-300">
                                            <Settings className="w-16 h-16 mb-4 opacity-20" />
                                            <p>{t.selectShop}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>